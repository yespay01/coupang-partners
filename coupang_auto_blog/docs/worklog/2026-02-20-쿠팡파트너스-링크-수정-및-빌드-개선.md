# 2026-02-20 작업내역: 쿠팡 파트너스 딥링크 수정 및 빌드 개선

## 요약

| 작업 | 파일 | 결과 |
|------|------|------|
| 쿠팡 딥링크 입력 URL 수정 | `collect.js` | 딥링크 생성 성공 |
| 딥링크 매핑 로직 개선 | `collect.js` | 정확한 URL 매핑 |
| subId 빈 문자열 전송 방지 | `deeplink.js` | API 오류 제거 |
| Next.js 빌드 Retrying 수정 | `reviews/[slug]/page.tsx` | 빌드 시간 6초 단축 |
| 메인페이지 디자인 개편 | `web/app/*` | 배포 완료 |

---

## 1. 쿠팡 파트너스 딥링크 - 핵심 수정

### 문제 원인

쿠팡 파트너스 딥링크 API는 **일반 쿠팡 URL**(`www.coupang.com`)을 입력받아 단축 affiliate URL(`coupa.ng/xxx`)로 변환한다.

그런데 상품 수집 API(`/products/search`, `/products/goldbox` 등)가 반환하는 `productUrl`은 **이미 affiliate URL** 형태다:

```
https://link.coupang.com/re/AFFSDP?lptag=AF1234567&pageKey=...&traceid=...
```

이 URL을 그대로 딥링크 API에 전달하면 API가 오류를 반환한다.

### 딥링크 API 스펙 (문서 기준)

```
POST /v2/providers/affiliate_open_api/apis/openapi/v1/deeplink

요청 Body:
{
  "coupangUrls": ["https://www.coupang.com/vp/products/184614775"],
  "subId": "string"   // 선택 사항, 없으면 생략
}

응답:
{
  "rCode": "0",
  "rMessage": "",
  "data": [
    {
      "originalUrl": "https://www.coupang.com/vp/products/184614775",
      "shortenUrl": "https://coupa.ng/blE0dT",
      "landingUrl": "https://link.coupang.com/re/AFFSDP?lptag=..."
    }
  ]
}
```

### 수정 내용

#### `automation-server/src/routes/collect.js`

**수정 전 (잘못됨):**
```javascript
// productUrl이 이미 link.coupang.com affiliate URL → API 오류 발생
const productUrls = products.map((p) => p.productUrl);
const deeplinkResult = await client.createDeeplinks(productUrls);

// 인덱스 기반 매핑 (순서가 다르면 잘못된 URL 매핑)
deeplinkResult.deeplinks.forEach((dl, index) => {
  if (dl.shortenUrl) {
    deeplinkMap.set(productUrls[index], dl.shortenUrl);
  }
});

const affiliateUrl = deeplinkMap.get(product.productUrl) || product.productUrl;
```

**수정 후 (올바름):**
```javascript
// productId로 www.coupang.com URL 생성 → API가 요구하는 형식
const deeplinkUrls = products.map((p) =>
  `https://www.coupang.com/vp/products/${p.productId}`
);
const deeplinkResult = await client.createDeeplinks(deeplinkUrls);

// productId를 키로 매핑 (정확한 매핑 보장)
deeplinkResult.deeplinks.forEach((dl, index) => {
  if (dl.shortenUrl) {
    deeplinkMap.set(products[index].productId, dl.shortenUrl);
  }
});

// productId로 조회, 실패 시 productUrl(이미 affiliate URL) 폴백
const affiliateUrl = deeplinkMap.get(product.productId) || product.productUrl;
```

#### `automation-server/src/services/coupang/deeplink.js`

**수정 전:**
```javascript
const body = {
  coupangUrls: Array.isArray(urls) ? urls : [urls],
  subId: subId || "",  // 빈 문자열 전송 → API 오류 가능
};
```

**수정 후:**
```javascript
const body = {
  coupangUrls: Array.isArray(urls) ? urls : [urls],
};
// subId 있을 때만 포함
if (subId) {
  body.subId = subId;
}
```

### 데이터 흐름 (수정 후)

```
상품 수집 API
  └─ productUrl: "link.coupang.com/re/AFFSDP?..." (이미 affiliate URL)
  └─ productId: 27664441

  ↓

딥링크 API 호출
  입력: "https://www.coupang.com/vp/products/27664441"
  출력: "https://coupa.ng/blE0dT"

  ↓

products 테이블 저장
  affiliate_url: "https://coupa.ng/blE0dT"  ← 단축 affiliate URL

  ↓

reviews 테이블 저장 (리뷰 생성 시)
  affiliate_url: "https://coupa.ng/blE0dT"

  ↓

블로그 게시 (review/[id] 페이지)
  "쿠팡에서 확인하기" 버튼 → coupa.ng 단축 URL
```

### 폴백 동작

딥링크 API가 실패하더라도 `product.productUrl` 자체가 이미 `link.coupang.com/re/AFFSDP?lptag=...` affiliate URL이므로 **파트너스 수익 추적은 유지된다.**

---

## 2. 이전 수정 (2026-02-19) - 맥락용

| 수정 | 내용 |
|------|------|
| API 경로 수정 | `/openapi/deeplink` → `/openapi/v1/deeplink` |
| rCode 비교 수정 | `!== 0` → `!= 0` (API가 문자열 `"0"` 반환) |

---

## 3. Next.js 빌드 Retrying 수정

### 문제 원인

`app/reviews/[slug]/page.tsx`의 `generateStaticParams()`가 빌드 중 automation-server에 API 호출:

```javascript
// 수정 전
export async function generateStaticParams() {
  try {
    const response = await fetch(`${AUTOMATION_SERVER_URL}/api/reviews?limit=100`);
    // ...
  } catch {
    return [];
  }
}
```

Docker 빌드 시 automation-server가 없어서 fetch 실패 → Next.js 내부 재시도 → **"Retrying 1/3..." 메시지 수백 개**

### 수정 후

```javascript
// 수정 후
export async function generateStaticParams() {
  return []; // 빌드 중 API 호출 없음
}
// dynamicParams=true + revalidate=3600(ISR)으로 런타임에 동적 처리
```

### 빌드 결과 비교

| | 이전 빌드 | 이번 빌드 |
|---|---|---|
| Retrying 메시지 | 수백 개 | **0개** |
| Next.js 빌드 시간 | ~142초 | **~136초** |

> **원인**: 개발 환경에서는 automation-server가 같이 실행 중이라 API 호출이 성공해서 문제를 못 느꼈고, Docker 빌드 환경에서만 발생하는 패턴이었음.

---

## 주의사항

- `generateStaticParams()` 안에 외부 API 호출 넣지 말 것 (빌드 타임에 서버 없음)
- 딥링크 API 입력값은 반드시 `https://www.coupang.com/vp/products/{productId}` 형태
- `subId`는 값이 있을 때만 body에 포함

---

*작성: 2026-02-20*
