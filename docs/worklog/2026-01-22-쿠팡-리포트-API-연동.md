# 2026-01-22: 쿠팡 리포트 API 연동 및 대시보드 수익 차트 구현

## 작업 개요

쿠팡 파트너스 리포트 API를 연동하여 대시보드에 실제 수익 데이터를 표시하도록 구현했습니다.

---

## 1. TopicSettings UI 수정

### 문제
- UI에 "쿠팡 API 검색은 1시간당 최대 10회" 라는 잘못된 제한 안내가 표시됨
- 실제 쿠팡 공식 문서에는 검색 API 제한이 명시되어 있지 않음

### 해결
**파일: `web/components/admin/settings/TopicSettings.tsx`**
```typescript
// 변경 전
<p className="text-xs text-slate-400">
  입력한 키워드로 쿠팡에서 상품을 검색합니다. (쿠팡 API 검색은 1시간당 최대 10회)
</p>

// 변경 후
<p className="text-xs text-slate-400">
  입력한 키워드로 쿠팡에서 상품을 검색합니다.
</p>
```

### 실제 API 제한 (문서 기준)
- **Reco API v2**: 분당 100회 (기본 QPS)
- **Reports API**: 시간당 500회
- **Search API / Deeplink API**: 제한 명시 없음

---

## 2. 쿠팡 리포트 API 연동

### 2.1 백엔드 API 함수 추가

**파일: `functions/src/coupangApi.js`**

추가된 함수들:
```javascript
// 일별 클릭 수 조회
export async function getClicksReport(params, credentials)

// 일별 주문 정보 조회
export async function getOrdersReport(params, credentials)

// 일별 취소 정보 조회
export async function getCancelsReport(params, credentials)

// 일별 수익 정보 조회
export async function getCommissionReport(params, credentials)
```

**API 엔드포인트:**
- `/v2/providers/affiliate_open_api/apis/openapi/v1/reports/clicks`
- `/v2/providers/affiliate_open_api/apis/openapi/v1/reports/orders`
- `/v2/providers/affiliate_open_api/apis/openapi/v1/reports/cancels`
- `/v2/providers/affiliate_open_api/apis/openapi/v1/reports/commission`

**파라미터:**
- `startDate`: YYYYMMDD 형식
- `endDate`: YYYYMMDD 형식

**createCoupangClient에 추가:**
```javascript
getClicksReport: (startDate, endDate) =>
  getClicksReport({ startDate, endDate }, credentials),

getOrdersReport: (startDate, endDate) =>
  getOrdersReport({ startDate, endDate }, credentials),

getCancelsReport: (startDate, endDate) =>
  getCancelsReport({ startDate, endDate }, credentials),

getCommissionReport: (startDate, endDate) =>
  getCommissionReport({ startDate, endDate }, credentials),
```

### 2.2 웹 API 라우트 생성

**파일: `web/app/api/coupang/reports/route.ts`** (신규)

```typescript
interface ReportRequest {
  accessKey: string;
  secretKey: string;
  reportType: "clicks" | "orders" | "cancels" | "commission";
  startDate: string; // YYYYMMDD
  endDate: string; // YYYYMMDD
}

export async function POST(request: NextRequest)
```

**기능:**
- HMAC 서명 생성
- 쿠팡 리포트 API 호출
- 에러 처리 및 응답 반환

### 2.3 타입 정의 추가

**파일: `web/types/settings.ts`**

```typescript
export type ReportType = "clicks" | "orders" | "cancels" | "commission";

export type ClickReportItem = {
  date: string;
  clicks: number;
  subId?: string;
};

export type OrderReportItem = {
  date: string;
  orderCnt: number;
  quantity: number;
  gmv: number;
  subId?: string;
};

export type CancelReportItem = {
  date: string;
  cancelCnt: number;
  cancelGmv: number;
  subId?: string;
};

export type CommissionReportItem = {
  date: string;
  commission: number;
  subId?: string;
};

export type ReportData = {
  clicks: ClickReportItem[];
  orders: OrderReportItem[];
  cancels: CancelReportItem[];
  commission: CommissionReportItem[];
};

export type ReportSummary = {
  totalClicks: number;
  totalOrders: number;
  totalGmv: number;
  totalCommission: number;
  totalCancels: number;
  period: {
    startDate: string;
    endDate: string;
  };
};
```

### 2.4 리포트 조회 훅 생성

**파일: `web/hooks/useCoupangReports.ts`** (신규)

```typescript
/**
 * 쿠팡 리포트 조회 훅
 * @param days 조회할 기간 (일 수, 기본 30일)
 */
export function useCoupangReports(days: number = 30)

/**
 * 오늘의 수익 조회 훅
 */
export function useTodayCommission()
```

**기능:**
- React Query로 4가지 리포트 병렬 조회
- 자동 캐싱 (15분 staleTime)
- 요약 데이터 자동 계산
- 설정에서 쿠팡 API 활성화 여부 확인

**사용 예시:**
```typescript
const {
  clicks,
  orders,
  cancels,
  commission,
  summary,
  isLoading,
  error,
  refetch
} = useCoupangReports(7); // 최근 7일
```

---

## 3. 대시보드 수익 차트 재구현

### 3.1 EarningsChart 컴포넌트 완전 재작성

**파일: `web/components/admin/EarningsChart.tsx`**

**주요 기능:**

1. **기간 선택**
   - 7일 / 14일 / 30일 선택 가능
   - 버튼으로 쉽게 전환

2. **차트 시각화**
   - 일별 수익을 막대 그래프로 표시
   - 호버 시 툴팁으로 날짜와 금액 표시
   - 최대값 기준 비율 계산

3. **통계 표시**
   ```typescript
   - 총 수익 (totalCommission)
   - 평균 수익/일 (avgCommission)
   - 총 클릭 (totalClicks)
   - 클릭당 수익 (revenuePerClick)
   - 주문 건수 (totalOrders)
   - 매출 GMV (totalGmv)
   ```

4. **상태별 UI**
   - **API 미연동**: 설정 페이지 안내
   - **로딩 중**: 스켈레톤 애니메이션
   - **에러**: 에러 메시지 + 재시도 버튼
   - **데이터 없음**: 안내 메시지

5. **새로고침 기능**
   - 버튼 클릭으로 수동 갱신 가능

**코드 구조:**
```typescript
export function EarningsChart() {
  const [periodDays, setPeriodDays] = useState<PeriodDays>(7);
  const { isLoading: isSettingsLoading } = useSystemSettings();

  const {
    commission,
    clicks,
    orders,
    summary,
    isEnabled,
    isLoading: isReportsLoading,
    error,
    refetch
  } = useCoupangReports(periodDays);

  const isLoading = isSettingsLoading || isReportsLoading;

  // 차트 데이터 계산
  const chartData = useMemo(() => {
    // 날짜 정렬, 최근 N일 추출, 최대값 대비 비율 계산
  }, [commission, periodDays]);

  // 통계 계산
  const stats = useMemo(() => {
    // avgCommission, revenuePerClick 등 계산
  }, [chartData.length, summary]);

  // UI 렌더링
}
```

### 3.2 Hooks export 추가

**파일: `web/hooks/index.ts`**

```typescript
// 시스템 설정 Hooks
export {
  useSystemSettings,
  useSettingsValidation,
  useCoupangConnectionTest,
} from "./useSystemSettings";

// 쿠팡 리포트 Hooks
export { useCoupangReports, useTodayCommission } from "./useCoupangReports";
```

---

## 4. 데이터 흐름

```
┌─────────────────────────────────────────┐
│ 1. EarningsChart 컴포넌트               │
│    - periodDays 선택 (7/14/30일)       │
└─────────────┬───────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────┐
│ 2. useCoupangReports(periodDays)        │
│    - useSystemSettings로 API 키 로드    │
│    - 날짜 계산 (startDate, endDate)     │
└─────────────┬───────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────┐
│ 3. React Query (병렬 조회)              │
│    - clicks, orders, cancels, commission│
│    - 각각 독립적인 쿼리                 │
└─────────────┬───────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────┐
│ 4. /api/coupang/reports (POST)          │
│    - HMAC 서명 생성                     │
│    - 쿠팡 API 호출                      │
└─────────────┬───────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────┐
│ 5. 쿠팡 파트너스 API                    │
│    /v1/reports/{reportType}             │
│    - startDate, endDate 파라미터        │
└─────────────┬───────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────┐
│ 6. 응답 데이터 반환                     │
│    - data: ReportItem[]                 │
│    - summary 자동 계산                  │
└─────────────┬───────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────┐
│ 7. EarningsChart 렌더링                 │
│    - 막대 차트                          │
│    - 통계 카드 (수익, 클릭, 주문 등)   │
└─────────────────────────────────────────┘
```

---

## 5. 파일 변경 사항

### 신규 생성
- ✅ `web/app/api/coupang/reports/route.ts`
- ✅ `web/hooks/useCoupangReports.ts`

### 수정
- ✅ `functions/src/coupangApi.js` - 리포트 API 함수 4개 추가
- ✅ `web/types/settings.ts` - 리포트 타입 추가
- ✅ `web/components/admin/EarningsChart.tsx` - 완전 재작성
- ✅ `web/components/admin/settings/TopicSettings.tsx` - 잘못된 제한 안내 제거
- ✅ `web/hooks/index.ts` - 훅 export 추가

---

## 6. 주요 특징

### 6.1 자동 캐싱
- React Query로 15분 캐싱
- 불필요한 API 호출 방지
- 시간당 500회 제한 대비

### 6.2 에러 처리
- API 연동 안됨: 설정 페이지 안내
- 네트워크 에러: 재시도 버튼
- 데이터 없음: 안내 메시지

### 6.3 반응형 UI
- 모바일/데스크탑 대응
- 툴팁으로 상세 정보 표시
- 원화 포맷 자동 변환

### 6.4 실시간 업데이트
- 새로고침 버튼
- 설정 변경 시 자동 반영
- 쿠팡 업데이트 시간 안내 (매일 오후 3시)

---

## 7. 테스트 방법

### 7.1 설정 페이지에서 쿠팡 API 연동
1. `/admin/settings` 접속
2. "쿠팡 API" 탭 선택
3. Access Key, Secret Key, Partner ID 입력
4. "연결 테스트" 버튼 클릭
5. "활성화" 토글 ON

### 7.2 대시보드에서 수익 확인
1. `/admin` 접속
2. 우측 "수익 추이" 차트 확인
3. 7일/14일/30일 버튼으로 기간 변경
4. 막대 차트에 호버로 일별 수익 확인
5. 하단 통계 카드 확인 (총 수익, 클릭, 주문 등)

### 7.3 에러 케이스 확인
- API 키 미입력: "쿠팡 API 연동 필요" 안내
- 잘못된 API 키: 에러 메시지 + 재시도 버튼
- 데이터 없음: "데이터가 없습니다" 표시

---

## 8. 후속 작업 (선택사항)

### 8.1 추가 차트
- 클릭 추이 차트
- 주문 추이 차트
- 전환율 차트 (클릭 → 주문)

### 8.2 상세 리포트 페이지
- `/admin/reports` 페이지 생성
- 테이블 형식으로 일별 데이터 표시
- CSV 다운로드 기능

### 8.3 알림 기능
- 일 수익 목표 달성 시 Slack 알림
- 급격한 클릭 감소 시 경고

### 8.4 예측 기능
- 과거 데이터 기반 수익 예측
- 트렌드 분석

---

## 9. 참고 문서

- 쿠팡 파트너스 공식 문서: `docs/쿠팡 api관련/문서.txt`
- Open API 가이드 v2: `docs/쿠팡 api관련/open api 가이드v2.txt`
- HMAC 서명 생성: `docs/쿠팡 api관련/HMAC 서명 생성 및 API 호출.txt`

---

## 10. 대시보드 메트릭스 실제 데이터 연동 (추가 작업)

### 10.1 문제점
- 대시보드 상단 메트릭스 (이번주 커미션, 클릭→주문 전환율, 금일 클릭수)가 더미 데이터로 표시됨
- 수익추이 그래프의 날짜 범위와 실제 데이터가 매칭되지 않음
- 데이터가 없는 날짜는 차트에서 빠짐

### 10.2 해결 방법

#### A. useDashboardMetrics 훅 생성

**파일: `web/hooks/useDashboardMetrics.ts`** (신규)

```typescript
export function useDashboardMetrics() {
  const { commission, clicks, orders } = useCoupangReports(30);

  const metrics = useMemo(() => {
    // 1. 이번주 커미션 계산 (월요일~일요일)
    const thisWeek = getThisWeekRange();
    const lastWeek = getLastWeekRange();
    const thisWeekCommission = commission
      .filter(item => item.date >= thisWeekStart && item.date <= thisWeekEnd)
      .reduce((sum, item) => sum + item.commission, 0);

    // 2. 금일 클릭 수
    const today = formatDateYYYYMMDD(new Date());
    const todayClicks = clicks
      .filter(item => item.date === today)
      .reduce((sum, item) => sum + item.clicks, 0);

    // 3. 클릭 → 주문 전환율 (최근 7일)
    const sevenDaysAgo = new Date();
    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
    const recentClicks = clicks.filter(...).reduce(...);
    const recentOrders = orders.filter(...).reduce(...);
    const conversionRate = (recentOrders / recentClicks) * 100;

    return [
      {
        id: "week-commission",
        label: "이번주 커미션",
        value: formatCurrency(thisWeekCommission),
        trend: `+${weekCommissionChange}% WoW`
      },
      {
        id: "conversion",
        label: "클릭 → 주문 전환율",
        value: formatPercent(conversionRate),
        trend: `+${conversionChange}pp`
      },
      {
        id: "today-clicks",
        label: "금일 클릭 수",
        value: formatNumber(todayClicks),
        trend: `+${clicksChange}% DoD`
      }
    ];
  }, [commission, clicks, orders]);

  return { metrics, isEnabled, isLoading, error };
}
```

**주요 기능:**
- 이번주/지난주 범위 계산 (월요일~일요일)
- 전주 대비 변화율 (WoW - Week over Week)
- 어제 대비 변화율 (DoD - Day over Day)
- 최근 7일 기준 전환율 계산

#### B. AdminDashboardView 수정

**파일: `web/components/AdminDashboardView.tsx`**

```typescript
// useDashboardMetrics 추가
import { useDashboardMetrics } from "@/hooks/useDashboardMetrics";

function AdminDashboardViewContent({ ... }) {
  // 실제 쿠팡 데이터로 메트릭스 가져오기
  const { metrics: coupangMetrics } = useDashboardMetrics();

  const {
    metrics: _firestoreMetrics, // 사용 안 함
    workflow,
    logs,
    // ...
  } = useAdminDashboardData({ ... });

  // 쿠팡 메트릭스 사용 (Firestore 메트릭스 대신)
  const metrics = coupangMetrics;
}
```

#### C. EarningsChart 날짜 매칭 수정

**파일: `web/components/admin/EarningsChart.tsx`**

**변경 전:**
```typescript
// 문제: 데이터가 있는 날짜만 표시됨
const sorted = [...commission].sort(...);
const recent = sorted.slice(-periodDays);
return recent.map(item => ({ ... }));
```

**변경 후:**
```typescript
// 해결: 전체 날짜 범위 생성 → 데이터 매칭
// 1. 오늘부터 N일 전까지의 날짜 배열 생성
const dates = [];
for (let i = periodDays - 1; i >= 0; i--) {
  const date = new Date(today);
  date.setDate(today.getDate() - i);
  dates.push(formatDateYYYYMMDD(date));
}

// 2. 날짜별 commission 맵 생성
const commissionMap = new Map();
commission.forEach(item => {
  commissionMap.set(item.date, item.commission);
});

// 3. 모든 날짜에 대한 데이터 생성 (없으면 0)
const dataPoints = dates.map(date => ({
  date,
  dateLabel: formatDateShort(date),
  value: commissionMap.get(date) ?? 0, // 없으면 0
}));
```

**효과:**
- 7일 선택 시 정확히 7개 막대 표시
- 데이터가 없는 날은 0으로 표시 (빈 막대)
- X축 날짜 레이블과 데이터 완벽 매칭

### 10.3 변경 파일 목록

**신규:**
- ✅ `web/hooks/useDashboardMetrics.ts`

**수정:**
- ✅ `web/components/AdminDashboardView.tsx` - useDashboardMetrics 적용
- ✅ `web/components/admin/EarningsChart.tsx` - 날짜 범위 매칭 수정
- ✅ `web/hooks/index.ts` - useDashboardMetrics export 추가

### 10.4 결과

**대시보드 메트릭스:**
- ✅ 이번주 커미션 (월~일) + WoW 변화율
- ✅ 클릭 → 주문 전환율 (최근 7일) + pp 변화
- ✅ 금일 클릭 수 + DoD 변화율
- ✅ API 미연동 시 "-" 표시

**수익추이 차트:**
- ✅ 선택한 기간(7/14/30일) 전체 날짜 표시
- ✅ 데이터 없는 날은 0 (빈 막대)
- ✅ X축 날짜와 데이터 완벽 매칭
- ✅ 총 클릭, 주문, 매출 정상 표시

---

## 11. 결론

✅ 쿠팡 리포트 API 완전 연동 완료
✅ 대시보드에 실제 수익 데이터 표시
✅ 이번주 커미션, 전환율, 금일 클릭수 실시간 계산
✅ 7일/14일/30일 기간별 차트 시각화 (날짜 매칭 완료)
✅ 총 수익, 클릭, 주문, 매출 통계 표시
✅ WoW, DoD, pp 변화율 표시
✅ 에러 처리 및 사용자 안내 완비

이제 관리자는 대시보드에서 실시간으로 쿠팡 파트너스 수익을 정확하게 확인할 수 있습니다.
