# 2026-01-29 작업 로그 - 페이지네이션 및 에러 핸들링 개선

## 작업 개요
페이지네이션 기능 추가 및 에러 핸들링 개선

---

## Task #4: 페이지네이션 개선 ✅

### 4.1 상품 목록 페이지네이션

**수정된 파일: `web/hooks/useProducts.ts`**

추가된 기능:
- Cursor 기반 페이지네이션
- 페이지 히스토리 관리
- 다음/이전/처음 페이지 이동

```typescript
// 새로 추가된 반환값
return {
  ...queryResult,
  pageIndex,
  hasNextPage,
  hasPrevPage,
  goToNextPage,
  goToPrevPage,
  goToFirstPage,
};
```

**수정된 파일: `web/components/admin/ProductList.tsx`**

추가된 UI:
- 상단/하단 페이지네이션 컨트롤
- 처음/이전/다음 버튼
- 현재 페이지 번호 표시

**수정된 파일: `web/app/(dashboard)/admin/products/page.tsx`**

페이지네이션 props 연결:
- useProducts hook에서 페이지네이션 함수 가져오기
- ProductList에 props 전달

### 4.2 로그 뷰어 페이지네이션

**상태:** ✅ 이미 구현됨
- `useAdminDashboardData.ts`에 cursor 기반 페이지네이션 로직 존재
- 로그 목록 페이지 이동 함수 구현 완료

---

## Task #5: 에러 핸들링 개선 ✅

### 5.1 전역 에러 페이지

**신규 파일: `web/app/error.tsx`**

기능:
- Next.js App Router 전역 에러 페이지
- 에러 아이콘 및 친화적인 UI
- 개발 환경에서 에러 상세 정보 표시
- 다시 시도 / 홈으로 버튼
- Error digest ID 표시

### 5.2 React 에러 바운더리

**신규 파일: `web/components/ErrorBoundary.tsx`**

기능:
- 클래스 컴포넌트 기반 에러 바운더리
- 커스텀 폴백 UI 지원
- 에러 로깅 기능
- HOC (withErrorBoundary) 제공
- 에러 복구 (reset) 기능

사용 예시:
```tsx
<ErrorBoundary>
  <MyComponent />
</ErrorBoundary>
```

**신규 파일: `web/components/ErrorMessage.tsx`**

기능:
- API 에러 메시지 표시 컴포넌트
- ErrorMessage: 상세 에러 표시 + 재시도 버튼
- InlineError: 간단한 인라인 에러

### 5.3 React Query 재시도 로직 개선

**수정된 파일: `web/components/QueryProvider.tsx`**

추가된 기능:

#### Exponential Backoff
```typescript
function getRetryDelay(attemptIndex: number): number {
  // 1초 * 2^attemptIndex, 최대 30초
  return Math.min(1000 * 2 ** attemptIndex, 30000);
}
```

시도별 딜레이:
- 1차: 1초
- 2차: 2초
- 3차: 4초
- 4차: 8초
- 최대: 30초

#### 스마트 재시도 판단
```typescript
function shouldRetry(failureCount: number, error: unknown): boolean {
  // 최대 3회까지 재시도
  if (failureCount >= 3) return false;

  // 네트워크 에러는 재시도
  if (message.includes("network") || message.includes("timeout")) {
    return true;
  }

  // 500번대 서버 에러는 재시도
  if (error.status >= 500 && error.status < 600) {
    return true;
  }

  return false;
}
```

재시도 조건:
- ✅ 네트워크 에러 (network, timeout, fetch, connection)
- ✅ 500번대 서버 에러
- ❌ 400번대 클라이언트 에러 (재시도하지 않음)
- ❌ 최대 3회 초과

### 5.4 대시보드 레이아웃에 에러 바운더리 적용

**수정된 파일: `web/app/(dashboard)/layout.tsx`**

```tsx
<main className="bg-slate-50 text-slate-900">
  <ErrorBoundary>{children}</ErrorBoundary>
</main>
```

효과:
- 대시보드 페이지 내 모든 에러 캐치
- 페이지 전체가 크래시되지 않고 에러 UI 표시

---

## 개선 효과

### 페이지네이션
- ✅ 초기 로딩 시간 감소 (50개 → 20개)
- ✅ 메모리 사용량 감소
- ✅ 사용자 경험 개선
- ✅ Firestore 읽기 비용 절감

### 에러 핸들링
- ✅ 전역 에러 처리 통일
- ✅ 네트워크 불안정 시 자동 재시도
- ✅ 사용자에게 친화적인 에러 메시지
- ✅ 에러 복구 기능
- ✅ 서비스 안정성 향상

---

## 파일 변경 요약

### 신규 파일 (4개)
- `web/app/error.tsx` - 전역 에러 페이지
- `web/components/ErrorBoundary.tsx` - 에러 바운더리
- `web/components/ErrorMessage.tsx` - 에러 메시지 컴포넌트
- `docs/worklog/2026-01-29-페이지네이션-및-에러핸들링-개선.md` - 이 파일

### 수정된 파일 (5개)
- `web/hooks/useProducts.ts` - 페이지네이션 추가
- `web/components/admin/ProductList.tsx` - 페이지네이션 UI 추가
- `web/app/(dashboard)/admin/products/page.tsx` - 페이지네이션 연결
- `web/components/QueryProvider.tsx` - 재시도 로직 개선
- `web/app/(dashboard)/layout.tsx` - 에러 바운더리 적용

### 문서 업데이트 (1개)
- `docs/architecture/project-structure.md` - 최신 구조 반영

---

## 재시도 로직 동작 예시

### 시나리오 1: 네트워크 타임아웃
```
1차 시도 실패 (타임아웃) → 1초 대기 → 재시도
2차 시도 실패 (타임아웃) → 2초 대기 → 재시도
3차 시도 성공 ✅
```

### 시나리오 2: 500 서버 에러
```
1차 시도 실패 (500) → 1초 대기 → 재시도
2차 시도 실패 (500) → 2초 대기 → 재시도
3차 시도 실패 (500) → 4초 대기 → 재시도
4차 시도 실패 (500) → 최대 횟수 초과 → 에러 표시 ❌
```

### 시나리오 3: 400 클라이언트 에러
```
1차 시도 실패 (400) → 재시도하지 않음 → 즉시 에러 표시 ❌
(클라이언트 에러는 재시도해도 해결되지 않으므로)
```

---

## 다음 권장 작업

### 프로덕션 배포 전 필수
- [ ] Firestore Rules 활성화
- [ ] Admin Custom Claim 설정
- [ ] 환경 변수 검증
- [ ] ADMIN_GUARD_BYPASS 비활성화
- [ ] 전체 기능 테스트
- [ ] 에러 로깅 서비스 연동 (Sentry 권장)

### 추가 개선 사항 (선택)
- [ ] 무한 스크롤 옵션 제공
- [ ] 에러 로깅 서비스 연동 (Sentry)
- [ ] 오프라인 지원 (Service Worker)
- [ ] 에러 알림 시스템 (Slack/Discord)

---

## 참고 자료

- [React Error Boundary 공식 문서](https://react.dev/reference/react/Component#catching-rendering-errors-with-an-error-boundary)
- [Next.js Error Handling](https://nextjs.org/docs/app/building-your-application/routing/error-handling)
- [React Query Retry Logic](https://tanstack.com/query/latest/docs/react/guides/query-retries)
- [Exponential Backoff](https://en.wikipedia.org/wiki/Exponential_backoff)
