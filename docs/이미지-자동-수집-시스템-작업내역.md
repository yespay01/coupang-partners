# 이미지 자동 수집 시스템 구축 작업 내역

**작업 기간:** 2026-01-30
**상태:** ✅ 완료

## 📋 작업 개요

블로그 리뷰에 자동으로 이미지를 추가하여 SEO 최적화 및 사용자 경험을 향상시키는 3단계 이미지 수집 시스템 구축

### 목표
1. 쿠팡 메인 이미지만 사용하는 현재 방식 개선
2. 다양한 소스에서 관련성 높은 이미지 자동 수집
3. 각 이미지 소스별 활성화/비활성화 제어
4. SEO 최적화 및 블로그 품질 향상

---

## 🏗️ 시스템 아키텍처

### 3단계 이미지 수집 프로세스

```
리뷰 생성 시작
    ↓
1. 쿠팡 메인 이미지 (항상 포함)
    ↓
2. 스톡 이미지 (선택)
   - Unsplash API
   - Pexels API
    ↓
3. AI 생성 이미지 (선택)
   - DALL-E 3
    ↓
4. 쿠팡 상세 이미지 (선택)
   - Puppeteer 스크래핑
    ↓
리뷰 저장 (media 배열)
```

---

## 📁 구현된 파일

### 1. Backend (Firebase Functions)

#### `functions/src/imageUtils.js` (신규)
**3단계 이미지 수집 핵심 로직**

```javascript
// 주요 함수
- extractKeywordFromProductName() // 상품명에서 키워드 추출
- fetchUnsplashImages() // Unsplash API 호출
- fetchPexelsImages() // Pexels API 호출
- generateAIImages() // DALL-E 이미지 생성
- scrapeCoupangImages() // Puppeteer 스크래핑
- collectAllImages() // 통합 수집 함수
```

**핵심 기능:**
- **브랜드명 자동 제거**: 50+ 한국 브랜드명 리스트
- **키워드 정제**: 용량, 숫자, 수식어 제거
- **에러 핸들링**: 각 단계별 실패해도 다른 단계는 계속 진행

**브랜드명 제거 예시:**
```
"탐사 실속형 배변패드 100매" → "배변패드"
"로얄캐닌 개사료 3kg" → "개사료"
"삼성 갤럭시 버즈 프로" → "갤럭시 버즈"
```

#### `functions/src/generateReview.js` (수정)
```javascript
// 기존
const media = [];
if (product.productImage) {
  media.push({ type: "image", url: product.productImage });
}

// 변경 후
import { collectAllImages } from "./imageUtils.js";
const media = await collectAllImages(product, settings);
```

#### `functions/src/services/settingsService.js` (수정)
**images 필드 추가**
- DEFAULT_SETTINGS에 images 설정 추가
- mergeWithDefaults 함수에 images 병합 로직 추가

**이슈 해결:**
- 초기에 백엔드에 images 필드가 없어서 `hasImagesConfig: false` 발생
- settings.images가 undefined로 전달되어 이미지 수집 스킵됨
- 추가 후 정상 작동

---

### 2. Frontend (Next.js Web)

#### `web/types/settings.ts` (수정)
```typescript
export type ImageSettings = {
  stockImages: {
    enabled: boolean;
    provider: "unsplash" | "pexels";
    apiKey: string;
    count: number; // 기본 2장
  };
  aiImages: {
    enabled: boolean;
    provider: "dalle" | "stable-diffusion";
    count: number; // 기본 1장
    quality: "standard" | "hd";
  };
  coupangDetailImages: {
    enabled: boolean;
    maxCount: number; // 기본 3장
    delayMs: number; // 기본 2000ms
  };
};
```

#### `web/components/admin/settings/ImageSettings.tsx` (신규)
**이미지 설정 관리 UI**

**주요 기능:**
- 3단계 이미지 소스별 개별 활성화/비활성화
- Provider 선택 (Unsplash/Pexels)
- API 키 입력 및 발급 링크
- 이미지 개수 설정
- AI 이미지 품질 선택
- 월 예상 비용 계산
- 활성화된 소스 요약 표시

**UI 구성:**
```
┌─────────────────────────────────────┐
│ 1단계: 스톡 이미지 (무료)         │
│ ☑ 활성화                           │
│ - Provider: Unsplash               │
│ - API 키: ****                     │
│ - 개수: 2장                        │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 2단계: AI 이미지 ($0.04/장)       │
│ ☐ 활성화                           │
│ - Provider: DALL-E 3               │
│ - 개수: 1장                        │
│ - 품질: Standard                   │
│ - 예상 비용: $4.00/월 (100개 기준)│
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 3단계: 쿠팡 상세 이미지 (주의)    │
│ ☐ 활성화                           │
│ - 최대 개수: 3장                   │
│ - 요청 간격: 2000ms                │
│ ⚠️ 법적 회색 지대                 │
└─────────────────────────────────────┘
```

#### `web/lib/settingsService.ts` (수정)
**images 필드 처리 추가**
- updateSystemSettings에 images 평탄화 로직 추가
- mergeWithDefaults에 images 병합 추가

**초기 이슈:**
- 설정 저장 시 images 필드가 무시됨
- Firestore에 저장은 되지만 백엔드에서 불러올 때 누락
- 수정 후 정상 작동

---

## 🔍 문제 해결 과정

### 이슈 1: 이미지가 전혀 수집되지 않음
**증상:** 리뷰에 메인 이미지 1개만 포함

**원인 분석:**
```javascript
// 로그 확인
hasSettings: true
hasImagesConfig: false  // ← 문제!
```

**해결:**
1. 백엔드 `settingsService.js`에 images 필드 추가
2. DEFAULT_SETTINGS에 images 기본값 추가
3. 병합 로직에 images 처리 추가

### 이슈 2: 상품과 관련 없는 이미지 수집
**증상:**
- 개사료 → 시계, 헤드폰, 신발 이미지
- 배변패드 → 배, 탐험 관련 이미지

**원인:**
- 카테고리 기반 고정 키워드 사용
- "탐사" 브랜드명이 "exploration"으로 검색됨

**해결:**
1. 카테고리 기반 → **상품명 기반** 검색으로 변경
2. **브랜드명 자동 제거** 로직 추가 (50+ 브랜드)
3. 용량, 숫자, 수식어 제거
4. 최종 키워드만 검색에 사용

### 이슈 3: Unsplash API 호출 성공했지만 이미지 없음
**증상:** API 200 OK이지만 리뷰에 이미지 없음

**원인:** Unsplash Demo 모드 사용량 한도
- Demo: 시간당 50 requests
- 테스트 중 46/50 사용
- 한도 거의 도달

**해결:**
1. Pexels 지원 추가 (월 200 requests)
2. Provider 전환 기능 구현
3. 설정 UI에서 언제든지 전환 가능

---

## 📊 각 이미지 소스 비교

| 소스 | 비용 | 한도 | 품질 | 관련성 | 추천도 |
|------|------|------|------|--------|--------|
| **Unsplash** | 무료 | 50/시간 (Demo)<br>5000/시간 (Pro) | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐ |
| **Pexels** | 무료 | 200/월 | ⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **DALL-E** | $0.04/장 | 무제한 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| **쿠팡 스크래핑** | 무료 | - | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐ |

**추천 조합:**
- **기본:** Pexels (무료, 안정적)
- **고급:** Pexels + DALL-E (비용 발생하지만 최고 품질)
- **비추:** 쿠팡 스크래핑 (법적 리스크)

---

## 🚀 사용 방법

### 1. 초기 설정

**Pexels 사용 (추천):**
```bash
1. https://www.pexels.com/api/ 접속
2. 무료 API 키 발급
3. 관리자 대시보드 → 설정 → 이미지 설정
4. Provider: "Pexels" 선택
5. API 키 입력
6. 개수: 2-3장 설정
7. 저장
```

**Unsplash Production 신청 (고급):**
```bash
1. https://unsplash.com/oauth/applications
2. Apply for production 클릭
3. 요구사항 충족:
   - Attribution 추가 (Photo by X on Unsplash)
   - Download endpoint 트리거
   - 스크린샷 제공
4. 승인 대기 (며칠~1주일)
5. 승인 후 시간당 5000 requests 사용 가능
```

### 2. 리뷰 생성 시 자동 이미지 수집

```javascript
// 자동으로 실행됨
1. 상품 수집
2. 리뷰 생성 트리거
3. collectAllImages() 자동 호출
4. 활성화된 소스에서 이미지 수집
5. media 배열에 저장
6. 리뷰 저장
```

### 3. 로그 확인

```bash
firebase functions:log | grep "이미지"

# 출력 예시
Unsplash 이미지 검색: "배변패드" (원본: "탐사 실속형 배변패드")
Unsplash API 응답 상태: 200
Unsplash API 응답 데이터: total=150, results=3
Unsplash 이미지 3장 가져오기 성공
총 4장의 이미지 수집 완료
```

---

## ⚙️ 설정 예시

### 기본 설정 (무료)
```javascript
{
  stockImages: {
    enabled: true,
    provider: "pexels",
    apiKey: "your-pexels-key",
    count: 2
  },
  aiImages: {
    enabled: false  // 비용 발생
  },
  coupangDetailImages: {
    enabled: false  // 법적 리스크
  }
}
```

### 고급 설정 (유료)
```javascript
{
  stockImages: {
    enabled: true,
    provider: "unsplash",  // Production 승인 후
    apiKey: "your-unsplash-key",
    count: 2
  },
  aiImages: {
    enabled: true,
    provider: "dalle",
    count: 1,
    quality: "standard"  // $0.04/장
  },
  coupangDetailImages: {
    enabled: false
  }
}
```

---

## 🔧 기술 스택

### Backend
- **Firebase Functions** (Node.js 20)
- **node-fetch** - HTTP 요청
- **puppeteer** - 웹 스크래핑
- **Firebase Admin SDK** - Firestore 연동

### Frontend
- **Next.js 15** - React 프레임워크
- **TypeScript** - 타입 안정성
- **Tailwind CSS** - 스타일링
- **Zustand** - 클라이언트 상태 관리

### External APIs
- **Unsplash API** - 스톡 이미지
- **Pexels API** - 스톡 이미지
- **OpenAI DALL-E 3** - AI 이미지 생성

---

## 📈 성능 고려사항

### API 호출 최적화
```javascript
// 병렬 처리 가능한 경우
const [stockImages, aiImages] = await Promise.all([
  fetchStockImages(product, settings),
  generateAIImages(product, settings)
]);

// 순차 처리 필요한 경우 (Rate limiting)
if (settings.images?.coupangDetailImages?.delayMs > 0) {
  await new Promise(resolve => setTimeout(resolve, delayMs));
}
```

### 에러 핸들링
```javascript
// 각 단계별 독립적 처리
try {
  const stockImages = await fetchStockImages();
  allImages.push(...stockImages);
} catch (error) {
  logger.error("스톡 이미지 실패", error);
  // 다음 단계로 계속 진행
}
```

### 캐싱 전략
```javascript
// settingsService.js
let cachedSettings = null;
let cacheTimestamp = 0;
const CACHE_TTL = 5 * 60 * 1000; // 5분

// 설정은 자주 바뀌지 않으므로 캐싱
if (cachedSettings && (now - cacheTimestamp) < CACHE_TTL) {
  return cachedSettings;
}
```

---

## ⚠️ 주의사항

### 1. API 키 보안
```bash
# ❌ 절대 코드에 하드코딩하지 말 것
const apiKey = "dYXa6JntLYi5AXHnCmPP38FHTZYzrcb5hFH47BO-PMY";

# ✅ Firestore에 저장하고 런타임에 로드
const { apiKey } = await getSystemSettings();
```

### 2. 쿠팡 이미지 스크래핑
```
⚠️ 법적 회색 지대
- 쿠팡 이용약관 위반 가능성
- IP 차단 위험
- 이미지 저작권 문제
- 사용 시 자기 책임
```

### 3. Unsplash 사용 시
```
✅ 반드시 Attribution 표시
- "Photo by [Name] on Unsplash"
- 링크 포함 필수
- Production 승인 조건

✅ Download endpoint 트리거
- 이미지 사용 시 다운로드 이벤트 전송
- API 요구사항
```

### 4. 비용 관리
```javascript
// AI 이미지 비용 계산
월 예상 비용 = 이미지 개수 × 리뷰 개수 × 단가

// 예시
DALL-E Standard: 1장 × 100개 리뷰 × $0.04 = $4/월
DALL-E HD: 1장 × 100개 리뷰 × $0.08 = $8/월
```

---

## 🐛 알려진 이슈

### 1. 한국어 키워드 검색 정확도
**문제:** Unsplash/Pexels는 영어 검색이 더 정확함

**해결 방안:**
- 브랜드명 제거로 어느 정도 개선
- 향후 한영 매핑 사전 추가 고려
- 또는 카테고리 키워드(영어) 병행 사용

### 2. Unsplash Demo 한도
**문제:** 시간당 50 requests로 테스트 제한적

**해결 방안:**
- Pexels 사용 (월 200 requests)
- Production 승인 신청
- 이미지 개수 줄이기

---

## 🔮 향후 개선 사항

### 1. 이미지 캐싱
```javascript
// 같은 키워드 반복 검색 방지
const imageCache = new Map();

if (imageCache.has(keyword)) {
  return imageCache.get(keyword);
}

const images = await fetchImages(keyword);
imageCache.set(keyword, images);
```

### 2. 한영 키워드 매핑
```javascript
const KEYWORD_MAP = {
  "개사료": "dog food",
  "배변패드": "pet pad",
  "고양이모래": "cat litter",
  // ...
};
```

### 3. 이미지 품질 검증
```javascript
// 이미지 크기, 비율 확인
async function validateImage(imageUrl) {
  const dimensions = await getImageDimensions(imageUrl);
  if (dimensions.width < 800 || dimensions.height < 600) {
    return false;
  }
  return true;
}
```

### 4. 다중 Provider 로테이션
```javascript
// Unsplash 한도 초과 시 자동으로 Pexels 사용
async function fetchWithFallback(product, settings) {
  try {
    return await fetchUnsplashImages(product, settings);
  } catch (error) {
    if (error.status === 429) { // Rate limit
      return await fetchPexelsImages(product, settings);
    }
    throw error;
  }
}
```

---

## 📝 테스트 체크리스트

- [x] 스톡 이미지 수집 (Unsplash)
- [x] 스톡 이미지 수집 (Pexels)
- [x] Provider 전환 기능
- [x] 브랜드명 제거
- [x] 키워드 정제
- [x] 에러 핸들링
- [x] 설정 저장/로드
- [x] UI 활성화/비활성화
- [ ] AI 이미지 생성 (OpenAI API 키 필요)
- [ ] 쿠팡 상세 이미지 스크래핑 (테스트 보류)
- [ ] Production 환경 테스트

---

## 📚 참고 문서

### API 문서
- [Unsplash API Docs](https://unsplash.com/documentation)
- [Pexels API Docs](https://www.pexels.com/api/documentation/)
- [OpenAI DALL-E API](https://platform.openai.com/docs/guides/images)

### 관련 코드
- `functions/src/imageUtils.js` - 이미지 수집 로직
- `functions/src/generateReview.js` - 리뷰 생성 통합
- `web/components/admin/settings/ImageSettings.tsx` - 설정 UI
- `web/types/settings.ts` - 타입 정의

---

## ✅ 완료 상태

**구현 완료:**
- ✅ 3단계 이미지 수집 시스템
- ✅ Unsplash/Pexels 지원
- ✅ DALL-E 지원
- ✅ 쿠팡 스크래핑 지원
- ✅ 브랜드명 자동 제거
- ✅ 설정 UI
- ✅ 에러 핸들링
- ✅ 디버깅 로그

**테스트 완료:**
- ✅ Unsplash API 연동 (Demo 한도 확인)
- ✅ Pexels 전환 기능
- ✅ 설정 저장/로드
- ✅ 브랜드명 제거 로직

**배포 완료:**
- ✅ Firebase Functions 배포
- ✅ Web UI 배포 준비

---

**작업 완료일:** 2026-01-30
**다음 단계:** Pexels API 키 발급 후 실사용 테스트
