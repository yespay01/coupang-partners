# 서버 측 작업 지침서

> 최종 업데이트: 2026-02-03
> 작업 분리: 로컬(개발) / 서버(배포 전용)

---

## ⚠️ 핵심 원칙

### 1. 파일 수정 금지
- 서버에서 직접 파일을 수정하지 않습니다
- 모든 코드 변경은 개발쪽에서 진행
- 전송된 파일만 사용

### 2. 배포만 담당
- 개발쪽에서 파일 전송 완료 통보 시에만 배포
- 지정된 배포 명령어만 사용

### 3. 대기 상태 유지
- 개발쪽에서 요청이 올 때까지 대기
- 자동화된 작업 없음

---

## ✅ 허용된 작업

### 1. 모니터링 (언제든 가능)
```bash
docker logs coupang-blog
docker ps
curl http://127.0.0.1:3000
systemctl status nginx
df -h  # 디스크 사용량
```

### 2. 상태 확인 (언제든 가능)
- 컨테이너 상태
- Nginx 상태
- 로그 확인
- 환경변수 확인

### 3. 긴급 재시작 (장애 시에만)
```bash
docker restart coupang-blog
sudo systemctl restart nginx
```

---

## ❌ 금지된 작업

### 1. 파일 수정
- ❌ nano/vim으로 코드 편집 금지
- ❌ Dockerfile 수정 금지
- ❌ next.config.ts 수정 금지
- ❌ 소스 코드 수정 금지

### 2. 임의 배포
- ❌ 개발쪽 통보 없이 빌드 금지
- ❌ 개발쪽 통보 없이 재배포 금지

### 3. 설정 변경
- ❌ docker-compose.yml 수정 금지
- ❌ Nginx 설정 변경 금지 (개발쪽 요청 시에만)

**단, .env.production 환경변수는 수정 가능**

---

## 📋 표준 배포 절차

개발쪽에서 "배포 준비 완료" 통보를 받으면:

### 1. 파일 전송 확인
```bash
cd /home/insuk/blog
ls -la
```

### 2. 배포 실행
```bash
docker stop coupang-blog && docker rm coupang-blog
docker build --no-cache -t blog-coupang-blog .
docker run -d \
  --name coupang-blog \
  --restart always \
  -p 3000:3000 \
  --env-file .env.production \
  blog-coupang-blog
```

### 3. 배포 확인
```bash
docker logs coupang-blog
curl -I http://127.0.0.1:3000
```

### 4. 결과 보고
- 성공: "✅ 배포 완료 - 컨테이너 정상 실행 중"
- 실패: "❌ 배포 실패 - [에러 메시지]"

---

## 🔧 환경변수 관리

### .env.production 수정 가능 항목

```bash
✅ ADMIN_GUARD_BYPASS=true/false
✅ NODE_ENV=development/production
✅ FIREBASE_ADMIN_* (필요 시)
```

**수정 후 반드시 재배포 필요!**

---

## 📊 모니터링 체크리스트

정기 확인 (문제 발생 시):

```bash
# 컨테이너 실행 확인
docker ps

# 로그 확인
docker logs coupang-blog --tail 50

# 앱 응답 확인
curl http://127.0.0.1:3000

# 외부 접속 확인
curl https://semolink.store

# 디스크 여유 확인
df -h
```

---

## 🚨 긴급 상황 대응

### 컨테이너 죽었을 때
```bash
docker restart coupang-blog
```

그래도 안되면:
```bash
docker logs coupang-blog --tail 100
# → 에러 로그 개발쪽에 전달
```

### Nginx 문제
```bash
sudo systemctl status nginx
sudo nginx -t
# → 결과 개발쪽에 전달
```

---

## 📝 작업 요청 유형

개발쪽에서 다음과 같은 요청이 올 수 있습니다:

### 1. "파일 전송 완료, 배포 진행"
→ 위 표준 배포 절차 실행

### 2. "환경변수 변경: [항목=값]"
→ .env.production 수정 후 재배포

### 3. "로그 확인 요청"
→ docker logs 결과 전달

### 4. "Nginx 설정 변경"
→ 전달받은 설정 파일로 교체 후 nginx 재시작

### 5. "상태 확인"
→ 모니터링 체크리스트 실행 후 보고

---

## 🔐 보안 주의사항

### 1. 환경변수 노출 금지
- 로그나 응답에 .env.production 내용 포함 금지
- Firebase 키, API 키 노출 금지

### 2. 포트 관리
**사용 중인 포트:**
- 3000: 블로그 (Next.js)
- 5432: PostgreSQL
- 5678: n8n
- 9001: MinIO Console
- 9002: MinIO API

**새 서비스 추가 시 개발쪽과 협의**

---

## 📞 커뮤니케이션 가이드

### 보고 형식

**성공:**
```
✅ [작업명] 완료 - [간단한 결과]

예: ✅ 배포 완료 - 컨테이너 정상 실행 중, 메모리 사용량 200MB
```

**실패:**
```
❌ [작업명] 실패 - [에러 메시지] - [시도한 해결책]

예: ❌ 빌드 실패 - npm install 에러 - package-lock.json 삭제 후 재시도했으나 동일
```

**진행 중:**
```
⏳ [작업명] 진행 중 - 예상 소요 시간: [X분]

예: ⏳ Docker 이미지 빌드 중 - 예상 소요 시간: 3분
```

---

## 🔄 개발 → 서버 배포 플로우

```
[로컬 개발]
    ↓
코드 수정/테스트
    ↓
서버로 파일 전송
    ↓
개발쪽: "배포 준비 완료" 통보
    ↓
[서버 측]
    ↓
파일 전송 확인
    ↓
배포 실행
    ↓
배포 확인
    ↓
결과 보고
    ↓
[배포 완료]
```

---

## 📂 서버 디렉토리 구조

```
/home/insuk/blog/
├── app/                    # Next.js 앱 디렉토리
├── components/             # React 컴포넌트
├── hooks/                  # Custom hooks
├── stores/                 # 상태 관리
├── types/                  # TypeScript 타입
├── public/                 # 정적 파일
├── Dockerfile              # Docker 이미지 정의
├── docker-compose.yml      # (사용 안 함)
├── .dockerignore           # Docker 빌드 제외
├── .env.production         # 환경변수 (수정 가능)
├── nginx-semolink.conf     # Nginx 설정
├── deploy-server.sh        # 배포 스크립트
├── next.config.ts          # Next.js 설정
├── package.json            # 의존성
└── ...
```

---

## 📋 배포 체크리스트

배포 전 확인사항:

- [ ] 개발쪽에서 파일 전송 완료 통보 받음
- [ ] `/home/insuk/blog/` 디렉토리에 파일 존재 확인
- [ ] 필수 파일 확인 (Dockerfile, package.json, next.config.ts)
- [ ] .env.production 파일 존재 및 내용 확인

배포 후 확인사항:

- [ ] 컨테이너 실행 중 (`docker ps`)
- [ ] 로그 에러 없음 (`docker logs coupang-blog`)
- [ ] 로컬 접속 가능 (`curl http://127.0.0.1:3000`)
- [ ] 외부 접속 가능 (`curl https://semolink.store`)
- [ ] UI 정상 표시 (브라우저 확인)

---

## 🆘 문제 해결 가이드

### 빌드 실패 시

1. 에러 로그 전체 복사
2. package.json 파일 확인
3. Dockerfile 문법 확인
4. 개발쪽에 에러 로그 전달

### 실행 실패 시

1. `docker logs coupang-blog --tail 100` 확인
2. 환경변수 확인 (`docker exec coupang-blog env`)
3. 포트 충돌 확인 (`netstat -tulpn | grep 3000`)
4. 개발쪽에 로그 전달

### CSS/UI 깨짐

1. 정적 파일 확인 (`docker exec coupang-blog ls -la /app/.next/static`)
2. CSS 파일 접근 확인 (`curl -I http://127.0.0.1:3000/_next/static/css/*.css`)
3. Nginx 로그 확인 (`tail -f /var/log/nginx/semolink-blog-error.log`)
4. 개발쪽에 상황 보고

---

## 📝 변경 이력

| 날짜 | 내용 |
|------|------|
| 2026-02-03 | 초기 지침 작성 |
| | - 작업 분리 원칙 수립 |
| | - 표준 배포 절차 정의 |
| | - 모니터링 체크리스트 작성 |

---

**현재 상태:** ⏸️ 대기 중
**다음 작업:** 개발쪽 지시 대기
