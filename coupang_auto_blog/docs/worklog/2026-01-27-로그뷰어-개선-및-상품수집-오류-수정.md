# 2026-01-27 작업 로그

## 작업 개요
로그 뷰어 "더보기" 기능 개선, 상품 수집 오류 수정, 후기 생성 안정화

---

## 1. 로그 뷰어 "더보기" 기능 구현

### 문제
- 에러 로그의 긴 메시지가 잘려서 전체 내용 확인 불가
- "더보기" 버튼이 작동하지 않음

### 원인 분석
1. `LogEntry` 타입에 `payload` 필드 누락
2. `toLogEntry` 함수에서 `payload` 전달 안 함
3. 실제 에러 메시지는 `payload.message`에 있는데 `entry.message`만 표시
4. Context가 JSON 문자열로 저장되어 있어 파싱 필요

### 해결 방법

#### 1) LogEntry 타입 수정 (`web/hooks/useAdminDashboardData.ts`)
```typescript
export type LogEntry = {
  id?: string;
  level: "info" | "warn" | "error";
  message: string;
  createdAt: string;
  context: string;
  payload?: Record<string, unknown>; // 추가
};
```

#### 2) toLogEntry 함수 개선
```typescript
function toLogEntry(doc: LogDoc): LogEntry {
  // payload가 없고 context가 JSON 문자열이면 파싱
  let payload = doc.payload;
  const context = doc.context ?? "";

  if (!payload && context.startsWith("{")) {
    try {
      payload = JSON.parse(context);
    } catch {
      // JSON 파싱 실패하면 무시
    }
  }

  return {
    id: doc.id,
    level: doc.level ?? "info",
    message: doc.message ?? "",
    createdAt: doc.createdAt ?? "",
    context,
    payload,
  };
}
```

#### 3) LogList 컴포넌트 개선 (`web/components/admin/LogList.tsx`)
```typescript
// payload.message 우선 표시
const actualMessage = payload?.message || entry.message;

// 에러 스택 표시
const errorStack = payload?.stack;
const hasErrorStack = errorStack && typeof errorStack === "string";

// 더보기 조건: 메시지 길이 또는 에러 스택 존재
const shouldShowMore = shouldTruncateMessage || hasErrorStack;

// 펼쳤을 때 스택 표시
{isExpanded && errorStack && (
  <pre className="mt-3 max-h-96 overflow-auto rounded-lg bg-slate-900/5 p-3 text-xs font-mono leading-relaxed">
    {errorStack}
  </pre>
)}
```

#### 4) SSR 에러 수정
```typescript
// window 접근 시 클라이언트 체크
if (typeof window !== "undefined" && logs.length > 0) {
  (window as any).__debugLogs = logs;
}
```

### 결과
- ✅ 긴 에러 메시지 전체 확인 가능
- ✅ 에러 스택 트레이스 코드 블록으로 표시
- ✅ 상품 ID, 시도 횟수 등 추가 정보 표시
- ✅ SSR 에러 해결

---

## 2. 상품 수집 카테고리 ID 오류 수정

### 문제
- 카테고리 수집 시 `category id is not found` 에러
- 잘못된 카테고리 ID 사용 (6, 9, 12, 14)

### 원인
- Firestore에 이전 잘못된 데이터가 저장됨
- 올바른 쿠팡 카테고리 ID는 1001 이상 (1001, 1002, 1010, ...)

### 해결 방법

#### 1) 설정 초기화 기능 추가

**settingsService.ts - resetSystemSettings 함수**
```typescript
export async function resetSystemSettings(): Promise<void> {
  const db = await getDb();
  const docRef = doc(db, SETTINGS_COLLECTION, GLOBAL_DOC_ID);

  // 기존 설정 읽기 (API 키 보존용)
  const docSnap = await getDoc(docRef);
  const currentSettings = docSnap.exists() ? docSnap.data() : null;

  // API 키 및 중요 설정 보존
  const preservedSettings = {
    automation: {
      enabled: currentSettings?.automation?.enabled ?? false,
      collectSchedule: currentSettings?.automation?.collectSchedule || DEFAULT_SETTINGS.automation.collectSchedule,
      maxProductsPerRun: currentSettings?.automation?.maxProductsPerRun || DEFAULT_SETTINGS.automation.maxProductsPerRun,
    },
    coupang: {
      enabled: currentSettings?.coupang?.enabled || false,
      accessKey: currentSettings?.coupang?.accessKey || "",
      secretKey: currentSettings?.coupang?.secretKey || "",
      partnerId: currentSettings?.coupang?.partnerId || "",
      subId: currentSettings?.coupang?.subId || "",
    },
    ai: {
      openai: { apiKey: currentSettings?.ai?.openai?.apiKey || "" },
      anthropic: { apiKey: currentSettings?.ai?.anthropic?.apiKey || "" },
      google: { apiKey: currentSettings?.ai?.google?.apiKey || "" },
    },
  };

  // 기존 문서 삭제 후 재생성
  await deleteDoc(docRef);
  await setDoc(docRef, {
    ...DEFAULT_SETTINGS,
    automation: preservedSettings.automation,
    coupang: { ...DEFAULT_SETTINGS.coupang, ...preservedSettings.coupang },
    ai: { /* API 키 보존하여 병합 */ },
    updatedAt: serverTimestamp(),
    updatedBy: "system",
  });
}
```

#### 2) 설정 페이지에 초기화 버튼 추가
```tsx
<button
  onClick={handleReset}
  disabled={isSaving}
  className="rounded-lg border border-red-300 bg-white px-4 py-2 text-sm font-medium text-red-600 hover:bg-red-50 disabled:opacity-50"
>
  초기화
</button>
```

### 결과
- ✅ 올바른 카테고리 ID로 복구 (1001, 1002, 1010, ...)
- ✅ API 키 및 자동화 설정 보존
- ✅ 상품 수집 정상 작동

---

## 3. 상품 수집 limit=0 에러 수정

### 문제
```
[카테고리 수집] API 호출: .../bestcategories/1002?limit=0
[카테고리 수집] 실패: limit is out of range
```

### 원인
1. 골드박스가 할당량을 모두 사용
2. 카테고리 할당량 계산 시 남은 상품 수 고려 안 함
3. `Math.floor(0 / 7) = 0` → limit=0으로 API 호출

### 해결 방법

#### Functions (`collectProducts.js`)
```javascript
async function collectByCategories(client, categories, maxProducts) {
  if (maxProducts <= 0) {
    logger.info(`카테고리 수집 건너뜀: 할당량 부족 (${maxProducts})`);
    return 0;
  }

  const productsPerCategory = Math.ceil(maxProducts / enabledCategories.length);
  // ...
}
```

#### Next.js API Route (`web/app/api/admin/collect/route.ts`)
```typescript
// 카테고리 수집 (40%)
const categoryAllocation = Math.floor(maxProducts * 0.4);
const remaining = Math.max(0, maxProducts - totalCollected);
const actualAllocation = Math.min(categoryAllocation, remaining);

if (actualAllocation <= 0) {
  console.log(`[카테고리 수집] 건너뜀: 할당량 부족`);
} else {
  const limit = Math.max(1, Math.floor(actualAllocation / enabledCategories.length));
  // API 호출
}
```

### 결과
- ✅ limit이 항상 1 이상 보장
- ✅ 할당량 부족 시 수집 건너뜀
- ✅ 상세한 로그로 디버깅 용이

---

## 4. 후기 생성 category undefined 에러 수정

### 문제
```
후기 생성 실패: Cannot use "undefined" as a Firestore value (found in field "category")
```

### 원인
- 상품 데이터에 `category` 필드 없음
- `categoryName`은 있지만 `category`로 접근
- Firestore는 undefined 값 허용 안 함

### 해결 방법

**functions/src/generateReview.js**
```javascript
// 이전
await db.collection("reviews").add({
  productId,
  content: reviewText,
  status: "draft",
  category: product.category, // undefined!
  // ...
});

// 수정 후
await db.collection("reviews").add({
  productId,
  content: reviewText,
  status: "draft",
  category: product.categoryName || product.category || "", // 안전하게 처리
  // ...
});
```

### 결과
- ✅ 후기 초안 정상 생성
- ✅ category 필드 안전하게 저장

---

## 5. Functions 배포

### 배포 명령어
```bash
# 특정 함수만 배포
firebase deploy --only functions:manualCollectProducts

# 모든 함수 배포
firebase deploy --only functions
```

### 배포된 함수 목록
- ✅ `generateReview` - 후기 자동 생성
- ✅ `publishReview` - 후기 발행 트리거
- ✅ `manualCollectProducts` - 수동 상품 수집
- ✅ `collectProductsScheduler` - 자동 수집 스케줄러
- ✅ `handleAdminActions` - 관리자 작업

---

## 수정된 파일 목록

### Frontend (Next.js)
1. `web/hooks/useAdminDashboardData.ts` - LogEntry 타입 및 변환 로직
2. `web/components/admin/LogList.tsx` - 더보기 기능 및 SSR 수정
3. `web/lib/settingsService.ts` - 설정 초기화 기능
4. `web/hooks/useSystemSettings.ts` - resetSettings 훅
5. `web/components/admin/settings/SettingsView.tsx` - 초기화 버튼
6. `web/app/api/admin/collect/route.ts` - 상품 수집 할당량 로직

### Backend (Functions)
1. `functions/src/collectProducts.js` - limit=0 방지 로직
2. `functions/src/generateReview.js` - category 안전 처리

---

## 개선 사항

### 성능
- 로그 뷰어: 페이징 없이 전체 로그 표시 (향후 페이징 필요)
- 상품 수집: 중복 체크 최적화 가능

### UX
- ✅ 에러 로그 상세 정보 확인 가능
- ✅ 설정 초기화 시 API 키 보존
- ✅ 할당량 로그로 수집 프로세스 투명화

### 안정성
- ✅ SSR 에러 방지 (window 체크)
- ✅ Firestore undefined 값 방지
- ✅ API limit 유효성 검증

---

## 남은 작업

### 즉시 필요
- [ ] 로그 페이징 구현 (성능)
- [ ] 에러 로그 필터링 개선
- [ ] 상품 수집 통계 대시보드

### 중장기
- [ ] 후기 자동 승인/발행 옵션
- [ ] 이미지 최적화
- [ ] SEO 메타데이터 개선
- [ ] 캐시 전략 수립

---

## 참고 사항

### 쿠팡 카테고리 ID 목록
```
1001: 여성패션
1002: 남성패션
1010: 뷰티
1011: 출산/유아동
1012: 식품
1013: 주방용품
1014: 생활용품
1015: 홈인테리어
1016: 가전디지털
1017: 스포츠/레저
1018: 자동차용품
1019: 도서/음반/DVD
1020: 완구/취미
1021: 문구/오피스
1024: 헬스/건강식품
1029: 반려동물용품
1030: 유아동패션
```

### 쿠팡 PL 브랜드 ID
```
1001: 탐사
1002: 코멧
1003: Gomgom
1004: 줌
1006: 곰곰
1007: 꼬리별
1008: 베이스알파에센셜
1010: 비타할로
1011: 비지엔젤
```
