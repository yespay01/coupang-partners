# 작업 보고서 — 2026년 2월 23일

## 개요

요리/뉴스/검색 페이지 전체 구현, 쿠팡 링크 체계 정리, 레시피 기능 대폭 개선 및 다수 버그 수정.
총 **14건 커밋**, 주요 기능 추가 3건 + 버그 수정 8건 + 문서 1건.

---

## 1. 요리/뉴스/검색 페이지 전체 구현 (신규)

| 항목 | 내용 |
|------|------|
| 커밋 | `85a0ddf` |
| 유형 | 신규 기능 |

### 백엔드
- DB 스키마: `recipes`, `news` 테이블 추가
- 공개 API: `recipe.js`, `news.js`, `search.js` 라우트 생성
- 관리자 API: `admin.js`에 레시피/뉴스 CRUD + AI 생성 엔드포인트 추가

### 프론트엔드
- 공개/관리자 API 프록시 라우트 12개 생성
- 관리자 페이지: `/admin/recipes` (AI 레시피 생성 + 쿠팡 재료 검색), `/admin/news` (AI 뉴스 생성)
- 공개 페이지: `/recipes`, `/recipes/[id]`, `/news`, `/news/[id]`, `/search`
- DashboardNav에 요리/뉴스 메뉴 링크 추가

---

## 2. 쿠팡 링크 체계 정리

| 항목 | 내용 |
|------|------|
| 커밋 | `afbb0ca`, `b99ed9f`, `49a8a33`, `9c5800d` |
| 유형 | 기능 개선 + 버그 수정 |

### 변경 내용
- 링크 명칭 통일: "원본 링크" → "제휴 링크", "제휴 링크" → "딥링크 (단축)"
- `search.js`, `admin.js`에서 불필요한 딥링크 변환 로직 제거
- `collect.js`: 상품 수집 시 불필요한 딥링크 API 호출 제거 (4개 함수 정리)
- `review.js`: 리뷰 생성 시 딥링크 대신 제휴 링크 사용
- 수집 상품 UI에서 딥링크 버튼 삭제, 제휴 링크만 표시
- 관리자 딥링크 변환 도구 추가 (일반 URL → 제휴 단축 URL)

---

## 3. 레시피 기능 대폭 개선

| 항목 | 내용 |
|------|------|
| 커밋 | `890c736`, `de283e1`, `af3fbf6`, `e0838e5` |
| 유형 | 기능 개선 |

### 3-1. 대표 이미지 자동 검색
- AI로 요리명을 영어 음식 키워드로 번역 후 Unsplash/Pexels 검색
- 예: "김치찌개" → "kimchi stew" → 관련 음식 이미지 자동 첨부
- 관리자 화면에서 이미지 URL 직접 수정 가능

### 3-2. 재료 전체 쿠팡 검색
- 기존: `ingredients.slice(0, 8)` — 최대 8개만 검색
- 변경: 전체 재료 검색으로 확대

### 3-3. 공개 페이지 순서 변경
- 변경 전: 재료 → 쿠팡 구매 → 조리법
- 변경 후: 재료 → 조리법 → 쿠팡에서 재료 구매하기 (마지막)

### 3-4. 조리시간/난이도 추가
- DB: `cooking_time VARCHAR(100)`, `difficulty VARCHAR(50)` 컬럼 추가
- AI 프롬프트에 `cookingTime`, `difficulty` 필드 생성 규칙 추가
- 공개 페이지: 제목 아래 시계/번개 아이콘으로 표시
- 관리자 수정 화면: 조리시간 텍스트 + 난이도 드롭다운 편집 가능

### 3-5. 레시피 프롬프트 관리자 설정 페이지
- 신규 페이지: `/admin/recipe-prompt`
- 시스템 프롬프트 / 유저 프롬프트 편집 (textarea)
- `{dishName}` 플레이스홀더 자동 치환 안내
- "기본값으로 초기화" 버튼
- DB `settings` 테이블에 `recipePrompt` 키로 저장/로드
- DashboardNav에 "레시피 설정" 메뉴 추가

### 3-6. 레시피 수정 기능
- 관리자에서 제목/설명/재료/조리법 수정 UI 추가
- 레시피 발행 취소(초안으로) 기능 추가

---

## 4. 버그 수정

### 4-1. 쿠팡 검색 502 에러 (limit out of range)
| 항목 | 내용 |
|------|------|
| 커밋 | `4c6903d`, `08c4ea6` |
| 원인 | `limit=20`이 쿠팡 API 허용 범위 초과 |
| 수정 | `Math.min(Math.max(parseInt(limit) \|\| 10, 1), 100)`, 기본값 10 |

### 4-2. Gemini MAX_TOKENS 경고 (키워드 추출)
| 항목 | 내용 |
|------|------|
| 커밋 | `af3fbf6`, `f1c6c0d` |
| 원인 | 키워드 추출 시 maxTokens가 부적절 (30 → 256 → 50) |
| 수정 | maxTokens를 50으로 최적화, 프롬프트를 영어로 간결하게 변경 |

### 4-3. 레시피 이미지 엉뚱한 결과 (잠자리 이미지)
| 항목 | 내용 |
|------|------|
| 커밋 | `de283e1` |
| 원인 | `fetchStockImages()`가 상품용으로 설계되어 요리명 번역 실패 |
| 수정 | AI로 요리명 → 영어 음식 키워드 번역 후 직접 Unsplash/Pexels 검색 |

### 4-4. 조리법에 마크다운 서식 포함
| 항목 | 내용 |
|------|------|
| 커밋 | `14772ac` |
| 원인 | Gemini가 `**볼드**` 등 마크다운 서식 삽입 |
| 수정 | 시스템 프롬프트 + 유저 프롬프트 모두에 마크다운 금지 규칙 명시 |

### 4-5. Dockerfile에 db 폴더 누락
| 항목 | 내용 |
|------|------|
| 커밋 | `d399449` |
| 원인 | `COPY src ./src`만 있어 `db/schema.sql`이 컨테이너에 미포함 |
| 수정 | `COPY db ./db` 추가 |

### 4-6. DB 스키마 자동 실행 누락
| 항목 | 내용 |
|------|------|
| 커밋 | `f1c6c0d` |
| 원인 | `initializeSchema()` 함수가 존재하지만 `index.js`에서 호출하지 않음 |
| 수정 | `index.js`에 import 추가 + `testConnection()` 후 `initializeSchema()` 호출 |

---

## 5. 수정 파일 목록

| 파일 | 주요 변경 |
|------|----------|
| `automation-server/src/index.js` | initializeSchema() 호출 추가 |
| `automation-server/src/routes/admin.js` | 레시피/뉴스 CRUD, 이미지 검색, 프롬프트 개선, 링크 정리 |
| `automation-server/src/routes/recipe.js` | 공개 레시피 API (cookingTime, difficulty 포함) |
| `automation-server/src/routes/news.js` | 공개 뉴스 API (신규) |
| `automation-server/src/routes/search.js` | 쿠팡 검색 limit 안전 처리 |
| `automation-server/src/routes/collect.js` | 딥링크 변환 제거 |
| `automation-server/src/routes/review.js` | 제휴 링크 사용으로 변경 |
| `automation-server/db/schema.sql` | recipes/news 테이블 + cooking_time/difficulty 컬럼 |
| `automation-server/Dockerfile` | `COPY db ./db` 추가 |
| `web/app/recipes/[id]/page.tsx` | 순서 변경, 이미지, 조리시간/난이도 |
| `web/app/(dashboard)/admin/recipes/page.tsx` | 이미지, 수정 기능, 조리시간/난이도 |
| `web/app/(dashboard)/admin/recipe-prompt/page.tsx` | 프롬프트 설정 페이지 (신규) |
| `web/app/(dashboard)/admin/news/page.tsx` | 뉴스 관리 페이지 (신규) |
| `web/app/news/[id]/page.tsx` | 뉴스 상세 페이지 (신규) |
| `web/app/search/page.tsx` | 쿠팡 검색 페이지 (신규) |
| `web/components/admin/DashboardNav.tsx` | 메뉴 추가 (요리/뉴스/레시피 설정) |
| 기타 API 프록시 라우트 | 12개 route.ts 파일 |

---

## 6. 쿠팡 파트너스 클릭 미반영 문제 해결 (2차 세션)

| 항목 | 내용 |
|------|------|
| 커밋 | `010c8f8`, `7a3fcd3` |
| 유형 | 버그 수정 |

### 원인 분석
- 쿠팡 API가 `subId` 파라미터를 지정하지 않으면 자동으로 lptag(`AF7225079`)를 `subid`에 삽입
- 결과: 링크가 `subid=AF7225079`로 생성되어 파트너스 대시보드에서 별도 채널 클릭으로 집계됨
- 인포크 서비스 비교 분석으로 원인 확인 (`subid=` 빈값 vs `subid=AF7225079`)

### 수정 내용
- `searchProducts()`: `subId: subId || ''` 명시적 빈값 전달
- `getGoldboxProducts()`, `getBestProducts()`, `getCoupangPLProducts()`, `getCoupangPLBrandProducts()` 동일 수정
- 결과: 쿠팡이 반환하는 URL의 `subid=` 빈값 유지 → 파트너스 대시보드 정상 집계

---

## 7. 쿠팡 다이나믹 배너 구현 (2차 세션)

| 항목 | 내용 |
|------|------|
| 커밋 | `3ea1930`, `014dd5c`, `5f88397`, `15c3e78`, `a53afbf` |
| 유형 | 신규 기능 + 버그 수정 |

### 구현 내용
- `CoupangDynamicBanner` 컴포넌트 신규 생성 (`web/components/CoupangDynamicBanner.tsx`)
- 쿠팡 파트너스 `g.js` 스크립트 비동기 로드 + 카루셀 위젯 삽입
- 검색 페이지(`/search`) 검색창 하단에 배너 적용

### 해결한 이슈
| 문제 | 원인 | 해결 |
|------|------|------|
| 배너 미표시 | `PartnersCoupang` 로드 전 실행 | 100ms 간격 재시도(최대 50회) |
| 배너가 페이지 맨 아래 표시 | 쿠팡 위젯이 `document.body`에 iframe 직접 삽입 | `MutationObserver`로 iframe 감지 후 컨테이너로 이동 |
| 모든 페이지에 배너 노출 | unmount 시 iframe 정리 없음 | cleanup 함수로 iframe + script 제거 |
| 여러 줄 누적 | React StrictMode 이중 실행 + 페이지 이동 시 누적 | 모듈 레벨 `activeCleanup` 싱글톤으로 중복 방지 |

---

## 8. 설정 주제 탭 카테고리 목록 복원 (2차 세션)

| 항목 | 내용 |
|------|------|
| 커밋 | `a2e6daa` |
| 유형 | 버그 수정 |

### 원인
- `web/lib/settingsService.ts`의 `getDefaultSettings()`에서 `categories: []` (빈 배열) 사용
- DB에서 설정을 불러올 때 기본값과 병합하지 않고 덮어씀
- 결과: 설정 → 주제 설정 탭에 카테고리 선택 버튼 17개 전부 미표시

### 수정
- `COUPANG_CATEGORIES` import 추가
- `getSystemSettings()`: DB 값과 기본값 deep merge (topics.categories 특별 처리)
- `getDefaultSettings()`: `categories: []` → `categories: COUPANG_CATEGORIES`

---

## 9. 상품 수집 subId 폴백 버그 추가 수정 (3차)

| 항목 | 내용 |
|------|------|
| 커밋 | `9ce1332` |
| 유형 | 버그 수정 |

### 원인
- `automation-server/src/services/coupang/index.js`의 `createCoupangClient`에서 모든 API 호출에 `subId: subId || partnerId` 사용
- JS에서 빈 문자열 `""`은 falsy → `"" || "AF7225079"` = `"AF7225079"` 로 평가
- `products.js`에서 빈값으로 고쳤어도 `index.js`에서 다시 `partnerId`로 채워짐
- 결과: 수집된 상품 URL에 `subid=AF7225079` 계속 삽입

### 수정
- `index.js` 내 7개 API 메서드 전부 `subId || partnerId` → `subId` 로 변경
- 대상: `searchProducts`, `getBestProducts`, `getGoldboxProducts`, `getCoupangPLProducts`, `getCoupangPLBrandProducts`, `createDeeplinks`, `testConnection`

---

## 10. 배포 참고 (최종)

서버에서 실행할 명령어:
```bash
cd /home/insuk/blog
git pull
docker-compose down
docker-compose build --no-cache
docker-compose up -d
```

로그 확인:
```bash
docker-compose logs -f
```

배포 후 확인 사항:
- `✅ Database schema initialized` 로그 출력 여부
- MAX_TOKENS 경고 없이 레시피 생성 정상 동작
- 공개 레시피 페이지 순서: 재료 → 조리법 → 쿠팡 구매
- 파트너스 대시보드에서 클릭 수 정상 집계 (subid= 빈값 확인)
- 검색 페이지 하단 다이나믹 배너 표시 확인
- 설정 → 주제 설정 탭에 카테고리 17개 표시 확인
