# 작업보고서 2026-02-24

## 요약

리뷰 슬러그 404 버그 수정, 이미지 400 오류 수정, 헤더/푸터 누락 수정, 요리/뉴스 slug 기반 URL 전환

---

## 작업 1: 리뷰 슬러그 404 버그 수정

### 문제
- `/reviews/이가네식품-냉면-...` 페이지 접속 시 404 반환
- automation-server 로그: `GET /reviews/by-slug 404 3ms`
- DB에는 slug 정상 존재

### 원인 분석
디버깅 로그 추가 후 확인:
```
[by-slug] slug value: "%EC%B2%9C%EC%82%AC..." (URL 인코딩된 채로 전달)
DB 저장값: "천사소녀-..." (한글 그대로)
```

Next.js 15에서 `params.slug`가 URL 인코딩된 값(`%EC%B2%9C...`)을 그대로 반환 → `url.searchParams.set()`이 `%`를 다시 `%25`로 인코딩 → 이중 인코딩 발생 → Express가 한 번만 디코딩하여 여전히 인코딩된 상태로 DB 조회

### 수정 내용
**`automation-server/src/routes/review.js`**
```js
// 수정 전
const { slug } = req.query;
const result = await db.query(`WHERE slug = $1`, [slug]);

// 수정 후
const rawSlug = req.query.slug;
const decodedSlug = decodeURIComponent(rawSlug);
const result = await db.query(`WHERE slug = $1`, [decodedSlug]);
```

---

## 작업 2: 이미지 400 오류 수정

### 문제
리뷰 상세 페이지 이미지 400 에러 (쿠팡 CDN 이미지, MinIO 이미지 등)

### 원인
`web/next.config.ts`에 `images.remotePatterns` 설정이 없어 Next.js Image 컴포넌트가 모든 외부 이미지를 400으로 차단

### 수정 내용
**`web/next.config.ts`**
```ts
images: {
  remotePatterns: [
    { protocol: "https", hostname: "**.coupangcdn.com" },
    { protocol: "https", hostname: "**.coupang.com" },
    { protocol: "http", hostname: "**" },
    { protocol: "https", hostname: "**" },
  ],
},
```

---

## 작업 3: 리뷰 상세 페이지 헤더/푸터 누락 수정

### 문제
`/reviews/[slug]` 페이지에 헤더와 푸터가 없음

### 원인
`web/app/reviews/[slug]/page.tsx`에서 `SiteHeader`, `SiteFooter` 컴포넌트 미포함

### 수정 내용
**`web/app/reviews/[slug]/page.tsx`**
```tsx
// 추가
import { SiteHeader } from "@/components/SiteHeader";
import { SiteFooter } from "@/components/SiteFooter";

// 레이아웃 적용
return (
  <div className="min-h-screen bg-white">
    <SiteHeader />
    <main className="pt-36 pb-32">
      <ReviewPost review={review} />
    </main>
    <SiteFooter />
  </div>
);
```

---

## 작업 4: 요리/뉴스 slug 기반 URL 전환

### 문제
- 레시피: `/recipes/42` (숫자 ID) → SEO 비효율
- 뉴스: `/news/13` (숫자 ID) → SEO 비효율
- slug는 이미 DB에 저장되어 있었으나 미사용

### 수정 내용

#### automation-server

**`automation-server/src/routes/recipe.js`** — `by-slug` 엔드포인트 추가
```js
router.get('/recipes/by-slug', async (req, res) => {
  const slug = decodeURIComponent(req.query.slug);  // 한글 slug 디코딩
  const result = await db.query(
    `SELECT * FROM recipes WHERE slug = $1 AND status = 'published'`, [slug]
  );
  // ...
});
```

**`automation-server/src/routes/news.js`** — `by-slug` 엔드포인트 추가
```js
router.get('/news/by-slug', async (req, res) => {
  const slug = decodeURIComponent(req.query.slug);
  const result = await db.query(
    `SELECT * FROM news WHERE slug = $1 AND status = 'published'`, [slug]
  );
  // ...
});
```

#### Web (Next.js)

**`web/app/recipes/[id]/page.tsx`** — 슬러그/ID 자동 판별
```ts
async function getRecipe(slugOrId: string) {
  if (/^\d+$/.test(slugOrId)) {
    // 숫자 → ID로 조회 (기존 링크 호환)
    return fetch(`/api/recipes/id/${slugOrId}`);
  }
  // 문자열 → slug로 조회 (한글 인코딩 처리)
  const url = new URL(`${AUTOMATION_SERVER_URL}/api/recipes/by-slug`);
  url.searchParams.set("slug", slugOrId);
  return fetch(url.toString());
}
```

**`web/app/news/[id]/page.tsx`** — 동일한 slug/ID 자동 판별 처리

**목록 페이지 링크 업데이트**
```tsx
// recipes/page.tsx
href={`/recipes/${recipe.slug || recipe.id}`}

// news/page.tsx
href={`/news/${news.slug || news.id}`}
```

---

## slug 형식 정리

| 컨텐츠 | slug 형식 | 예시 |
|--------|----------|------|
| 리뷰 | `{상품명}-{timestamp}` | `천사소녀-여성용-머리끈-1771924878359` |
| 레시피 | `{요리명}-{timestamp}` | `김치찌개-1706123456789` |
| 뉴스 | `news-{timestamp}` | `news-1706123456789` |

---

## 수정된 파일 목록

| 파일 | 변경 내용 |
|------|---------|
| `automation-server/src/routes/review.js` | by-slug 디버그 로그 추가 후 `decodeURIComponent` 수정 |
| `automation-server/src/routes/recipe.js` | `/recipes/by-slug` 엔드포인트 추가 |
| `automation-server/src/routes/news.js` | `/news/by-slug` 엔드포인트 추가 |
| `web/next.config.ts` | `images.remotePatterns` 추가 |
| `web/app/reviews/[slug]/page.tsx` | SiteHeader/Footer 추가 |
| `web/app/recipes/[id]/page.tsx` | slug/ID 자동 판별 처리 |
| `web/app/news/[id]/page.tsx` | slug/ID 자동 판별 처리 |
| `web/app/recipes/page.tsx` | 목록 링크 slug 우선 |
| `web/app/news/page.tsx` | 목록 링크 slug 우선 |

---

## 커밋 이력

```
276537f  fix: by-slug 엔드포인트 URL 인코딩 slug 디코딩 처리 추가
0671d38  fix: Next.js Image 외부 도메인 허용 설정 추가
98e1c30  fix: 리뷰 상세 페이지에 SiteHeader, SiteFooter 추가
71799e4  feat: 요리/뉴스 slug 기반 URL 전환 (by-slug 엔드포인트, ID 폴백 지원)
```

---

## 배포 방법

```bash
git pull
docker compose down
docker compose build
docker compose up -d
```
