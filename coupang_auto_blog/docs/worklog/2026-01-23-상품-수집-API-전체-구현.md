# 2026-01-23 - 상품 수집 API 전체 구현

## 작업 개요
쿠팡 파트너스 API의 모든 상품 수집 기능을 통합하여 다양한 소스에서 상품을 수집할 수 있도록 시스템을 확장했습니다.

## 목표
- 골드박스(타임딜) API 구현
- 쿠팡 PL(자체 브랜드) API 구현 (전체 + 브랜드별)
- 우선순위 기반 수집 전략 적용
- 관리자 UI에서 수집 소스 설정 가능

## 구현 내용

### 1. API 함수 추가 (`functions/src/coupangApi.js`)

#### 1.1 골드박스 API
```javascript
export async function getGoldboxProducts(params, credentials)
```
- **기능**: 골드박스(타임딜) 상품 조회
- **업데이트 주기**: 매일 오전 7:30
- **특징**: 시간 한정 할인 상품으로 클릭률이 높음
- **파라미터**: subId, imageSize

#### 1.2 쿠팡 PL 전체 API
```javascript
export async function getCoupangPLProducts(params, credentials)
```
- **기능**: 쿠팡 자체 브랜드(PL) 전체 상품 조회
- **한도**: 최대 100개
- **특징**: 높은 수수료율 제공
- **파라미터**: limit, subId, imageSize

#### 1.3 쿠팡 PL 브랜드별 API
```javascript
export async function getCoupangPLBrandProducts(params, credentials)
```
- **기능**: 특정 쿠팡 PL 브랜드 상품 조회
- **지원 브랜드**: 탐사, 코멧, Gomgom, 줌, 곰곰, 꼬리별, 베이스알파에센셜, 비타할로, 비지엔젤 (총 9개)
- **한도**: 최대 100개/브랜드
- **파라미터**: brandId, limit, subId, imageSize

#### 1.4 Client 메서드 확장
`createCoupangClient()`에 새 메서드 추가:
- `getGoldboxProducts(imageSize)`
- `getCoupangPLProducts(limit, imageSize)`
- `getCoupangPLBrandProducts(brandId, limit, imageSize)`

### 2. 수집 함수 추가 (`functions/src/collectProducts.js`)

#### 2.1 골드박스 수집 함수
```javascript
async function collectGoldbox(client, maxProducts)
```
- 골드박스 상품 수집
- 각 상품에 딥링크(제휴 URL) 자동 생성
- 중복 체크 후 Firestore 저장
- source: `"goldbox"`

#### 2.2 쿠팡 PL 수집 함수
```javascript
async function collectCoupangPL(client, brands, maxProducts)
```
- 선택된 브랜드별 상품 수집
- 브랜드당 균등 분배 (Math.ceil)
- 각 상품에 딥링크 생성
- source: `"coupangPL:{brandId}"`

### 3. 우선순위 기반 수집 전략

수집 스케줄러 로직을 개선하여 4단계 우선순위 적용:

```javascript
// 1. 골드박스 (20%) - 타임딜, 최우선
const goldboxCount = await collectGoldbox(client, Math.floor(maxProducts * 0.2));

// 2. 카테고리 베스트 (40%) - 검증된 인기 상품
const categoryCollected = await collectByCategories(client, categories, Math.floor(maxProducts * 0.4));

// 3. 키워드 검색 (30%) - 주제 관련 상품
const keywordCollected = await collectByKeywords(client, keywords, Math.floor(maxProducts * 0.3));

// 4. 쿠팡 PL (10%) - 높은 수수료율
const plCollected = await collectCoupangPL(client, coupangPLBrands, remaining);
```

#### 전략 설명
- **골드박스 20%**: 타임딜 상품으로 클릭률이 높아 최우선 배정
- **카테고리 베스트 40%**: 검증된 베스트셀러로 안정적인 성과
- **키워드 검색 30%**: 블로그 주제에 맞는 맞춤형 상품
- **쿠팡 PL 10%**: 높은 수수료율, 나머지 슬롯 활용

### 4. 타입 정의 추가 (`web/types/settings.ts`)

#### 4.1 쿠팡 PL 브랜드 타입
```typescript
export type CoupangPLBrand = {
  id: string;    // "1001", "1002", etc.
  name: string;  // "탐사", "코멧", etc.
};

export const COUPANG_PL_BRANDS: CoupangPLBrand[] = [
  { id: "1001", name: "탐사" },
  { id: "1002", name: "코멧" },
  { id: "1003", name: "Gomgom" },
  { id: "1004", name: "줌" },
  { id: "1006", name: "곰곰" },
  { id: "1007", name: "꼬리별" },
  { id: "1008", name: "베이스알파에센셜" },
  { id: "1010", name: "비타할로" },
  { id: "1011", name: "비지엔젤" },
];
```

#### 4.2 TopicSettings 타입 확장
```typescript
export type TopicSettings = {
  categories: CoupangCategory[];
  keywords: string[];
  goldboxEnabled: boolean;        // 골드박스 수집 활성화
  coupangPLBrands: string[];      // 선택된 PL 브랜드 ID 배열
};
```

#### 4.3 기본값 설정
```typescript
topics: {
  categories: COUPANG_CATEGORIES,
  keywords: [],
  goldboxEnabled: true,    // 기본값: 활성화
  coupangPLBrands: [],     // 기본값: 선택 없음
}
```

### 5. Zustand Store 업데이트 (`web/stores/settingsStore.ts`)

새로운 액션 추가:

```typescript
// 골드박스 토글
setGoldboxEnabled: (enabled: boolean) => void;

// PL 브랜드 설정
setCoupangPLBrands: (brands: string[]) => void;
toggleCoupangPLBrand: (brandId: string) => void;
```

구현 특징:
- `toggleCoupangPLBrand`: 브랜드 ID 배열에서 추가/제거 토글
- 모든 변경 시 `hasUnsavedChanges: true` 설정

### 6. UI 구현 (`web/components/admin/settings/TopicSettings.tsx`)

#### 6.1 골드박스 토글 스위치
```tsx
<button
  onClick={() => setGoldboxEnabled(!topics.goldboxEnabled)}
  className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${
    topics.goldboxEnabled ? "bg-blue-600" : "bg-slate-300"
  }`}
>
  <span className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${
    topics.goldboxEnabled ? "translate-x-6" : "translate-x-1"
  }`} />
</button>
```
- iOS 스타일 토글 스위치
- 활성화 시 파란색, 비활성화 시 회색
- 설명: "매일 오전 7:30 업데이트"

#### 6.2 쿠팡 PL 브랜드 선택 그리드
```tsx
<div className="grid grid-cols-2 gap-2 sm:grid-cols-3 lg:grid-cols-4">
  {COUPANG_PL_BRANDS.map((brand) => {
    const isSelected = (topics.coupangPLBrands || []).includes(brand.id);
    return (
      <button
        key={brand.id}
        onClick={() => toggleCoupangPLBrand(brand.id)}
        className={isSelected ? "border-green-500 bg-green-50" : "border-slate-200 bg-white"}
      >
        {brand.name}
      </button>
    );
  })}
</div>
```
- 카테고리 선택과 유사한 그리드 UI
- 선택 시 녹색, 미선택 시 회색
- 반응형 그리드: 모바일 2열, 태블릿 3열, 데스크톱 4열

#### 6.3 수집 전략 안내 박스
```tsx
<div className="rounded-lg border border-blue-200 bg-blue-50 p-4">
  <h4>수집 전략</h4>
  <ul>
    <li>• 골드박스 20% - 타임딜 상품 (클릭률 높음)</li>
    <li>• 카테고리 베스트 40% - 인기 검증된 상품</li>
    <li>• 키워드 검색 30% - 주제 관련 상품</li>
    <li>• 쿠팡 PL 10% - 높은 수수료율</li>
  </ul>
</div>
```
- 파란색 배경으로 눈에 띄게 표시
- 각 소스별 비중과 특징 설명

#### 6.4 설정 요약 업데이트
```tsx
<div>
  <span>골드박스:</span>
  {topics.goldboxEnabled ?
    <span className="text-green-600">활성화</span> :
    <span className="text-slate-400">비활성화</span>
  }
</div>
<div>
  <span>쿠팡 PL 브랜드:</span>
  {(topics.coupangPLBrands || []).length}개 선택됨
</div>
```
- 골드박스 활성화 상태 표시
- 선택된 PL 브랜드 개수 표시

## 로깅 및 모니터링

### Firestore 로그
```javascript
await db.collection("logs").add({
  type: "collection",
  level: "info",
  message: `상품 자동 수집 완료: ${totalCollected}개`,
  payload: {
    totalCollected,
    goldbox: collectionStats.goldbox,
    categories: collectionStats.categories,
    keywords: collectionStats.keywords,
    coupangPL: collectionStats.coupangPL,
    settings: {
      keywordCount: keywords.length,
      categoryCount: categories.filter((c) => c.enabled).length,
      plBrandCount: coupangPLBrands.length,
    },
  },
  createdAt: new Date(),
});
```

### Slack 알림
```javascript
await notifySlack({
  route: "collection",
  level: "success",
  title: "상품 자동 수집 완료",
  text: `${totalCollected}개의 새 상품이 수집되었습니다.`,
  fields: [
    { label: "골드박스", value: String(collectionStats.goldbox) },
    { label: "카테고리 베스트", value: String(collectionStats.categories) },
    { label: "키워드 검색", value: String(collectionStats.keywords) },
    { label: "쿠팡 PL", value: String(collectionStats.coupangPL) },
  ],
});
```

## 변경된 파일 목록

### Backend (Firebase Functions)
1. `functions/src/coupangApi.js`
   - `getGoldboxProducts()` 함수 추가
   - `getCoupangPLProducts()` 함수 추가
   - `getCoupangPLBrandProducts()` 함수 추가
   - `createCoupangClient()` 메서드 확장

2. `functions/src/collectProducts.js`
   - `collectGoldbox()` 함수 추가
   - `collectCoupangPL()` 함수 추가
   - 스케줄러 로직 개선 (우선순위 기반)
   - 통계 수집 및 로깅 강화

### Frontend (Next.js)
3. `web/types/settings.ts`
   - `CoupangPLBrand` 타입 추가
   - `COUPANG_PL_BRANDS` 상수 추가
   - `TopicSettings` 타입 확장
   - `DEFAULT_SETTINGS` 업데이트

4. `web/stores/settingsStore.ts`
   - `setGoldboxEnabled()` 액션 추가
   - `setCoupangPLBrands()` 액션 추가
   - `toggleCoupangPLBrand()` 액션 추가

5. `web/components/admin/settings/TopicSettings.tsx`
   - 골드박스 토글 UI 추가
   - PL 브랜드 선택 그리드 추가
   - 수집 전략 안내 박스 추가
   - 설정 요약 업데이트

## 테스트 체크리스트

### Backend
- [ ] 골드박스 API 호출 성공 확인
- [ ] 쿠팡 PL 전체 API 호출 성공 확인
- [ ] 쿠팡 PL 브랜드별 API 호출 성공 확인 (각 9개 브랜드)
- [ ] 딥링크 생성 정상 작동 확인
- [ ] 수집 스케줄러 실행 테스트 (우선순위 기반)
- [ ] Firestore 로그 저장 확인
- [ ] Slack 알림 전송 확인

### Frontend
- [ ] 골드박스 토글 UI 정상 작동
- [ ] PL 브랜드 선택/해제 정상 작동
- [ ] 설정 저장 후 Firestore 반영 확인
- [ ] 수집 전략 안내 표시 확인
- [ ] 설정 요약 정확성 확인
- [ ] 반응형 레이아웃 확인 (모바일/태블릿/데스크톱)

### 통합 테스트
- [ ] 골드박스 활성화 후 실제 수집 확인
- [ ] PL 브랜드 선택 후 실제 수집 확인
- [ ] 우선순위 기반 비율(20/40/30/10) 확인
- [ ] 수집 통계 정확성 확인
- [ ] 중복 상품 필터링 확인

## 기대 효과

### 1. 수집 상품 다양성 증가
- 기존: 카테고리 베스트 + 키워드 검색 (2가지)
- 개선: 골드박스 + 카테고리 + 키워드 + PL (4가지)

### 2. 클릭률 향상
- 골드박스(타임딜): 시간 한정 할인으로 클릭률 높음
- 우선순위 20% 배정으로 상위 노출

### 3. 수익률 증가
- 쿠팡 PL 상품: 높은 수수료율 제공
- 검증된 베스트셀러 위주 수집

### 4. 관리 편의성
- UI에서 모든 수집 소스 On/Off 가능
- 브랜드별 세밀한 선택 가능
- 수집 전략 시각화로 이해도 향상

## 다음 단계

1. **실제 수집 테스트**
   - 스케줄러 수동 실행
   - 각 소스별 수집 결과 확인
   - 로그 및 통계 검증

2. **성능 모니터링**
   - 골드박스 상품 클릭률 추적
   - PL 상품 수익률 추적
   - 소스별 효율성 분석

3. **최적화 검토**
   - 우선순위 비율 조정 필요 시 수정
   - API 호출 횟수 최적화
   - 딥링크 생성 병렬 처리 고려

## 참고 문서
- 쿠팡 파트너스 API: https://developers.coupangcorp.com/
- 골드박스 업데이트 시간: 매일 오전 7:30
- 쿠팡 PL 브랜드: 총 9개 (탐사, 코멧, Gomgom, 줌, 곰곰, 꼬리별, 베이스알파에센셜, 비타할로, 비지엔젤)
