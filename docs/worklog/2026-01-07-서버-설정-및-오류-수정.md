# 2026-01-07 서버 설정 및 오류 수정 작업 로그

## 작업 개요
웹 서버 실행 중 발생한 여러 오류를 수정하고 로그인 기능을 활성화함

## 작업 내용

### 1. Firebase 설정 추가
**문제**: Firebase 초기화 실패 - `projectId` 누락
**해결**: `.env.local` 파일에 Firebase 설정 추가

```env
NEXT_PUBLIC_FIREBASE_API_KEY=AIzaSyCPI1msAqKlbF83upcdEClY9xlAMhJs-3I
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=blog-automation-23092.firebaseapp.com
NEXT_PUBLIC_FIREBASE_PROJECT_ID=blog-automation-23092
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=blog-automation-23092.firebasestorage.app
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=944342575434
NEXT_PUBLIC_FIREBASE_APP_ID=1:944342575434:web:f9ee17d38296ffe0aaf9b3
NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=
NEXT_PUBLIC_FIREBASE_DATABASE_URL=https://blog-automation-23092-default-rtdb.asia-southeast1.firebasedatabase.app
```

**파일**: `web/.env.local`

---

### 2. Firestore limit 함수 이름 충돌 수정
**문제**: `TypeError: limit is not a function`
**원인**: Firebase의 `limit` 함수와 함수 파라미터 이름 충돌

**해결**: `web/lib/firestore.ts` 수정
```typescript
// Before
import { limit } from "firebase/firestore";

// After
import { limit as limitQuery } from "firebase/firestore";
```

**수정 위치**:
- `firestore.ts:4` - import 문 수정
- `firestore.ts:80` - `limitQuery(limit + 1)`
- `firestore.ts:136` - `limitQuery(max)`
- `firestore.ts:230` - `limitQuery(limit + 1)`

---

### 3. 로그인 기능 활성화
**변경**: 바이패스 모드에서 로그인 필수 모드로 전환

**수정**: `web/.env.local`
```env
# Before
ADMIN_GUARD_BYPASS=true

# After
# ADMIN_GUARD_BYPASS=true  # 로그인 필요하면 주석 처리
```

**동작**:
- `/admin` 접근 시 자동으로 `/admin/login`으로 리다이렉트
- 세션 쿠키가 없으면 접근 불가

---

### 4. 바이패스 로그인 API 수정
**문제**: 로그인 페이지에서 "로컬 개발용 세션 발급" 버튼 클릭 시 `idToken이 필요합니다` 오류

**해결**: `web/app/api/admin/session/route.ts` 수정

```typescript
// LoginBody 타입에 bypass 필드 추가
type LoginBody = {
  idToken?: string;
  bypass?: boolean;
};

// bypass 요청 처리 로직 추가
if (body.bypass === true || process.env.ADMIN_GUARD_BYPASS === "true") {
  cookieStore.set(ADMIN_COOKIE, "bypass", {
    httpOnly: true,
    sameSite: "lax",
    secure: process.env.NODE_ENV === "production",
    path: "/",
    maxAge: MAX_AGE_SECONDS,
  });
  return NextResponse.json({ success: true, bypass: true });
}
```

**파일**: `web/app/api/admin/session/route.ts:8-10, 17-37`

---

### 5. Next.js 캐시 문제 해결
**문제**: `Invariant: Expected clientReferenceManifest to be defined`
**해결**: `.next` 폴더 완전 삭제 후 재시작

```bash
cd web
rm -rf .next node_modules/.cache
npm run dev
```

---

### 6. Firestore 보안 규칙 설정
**문제**: `FirebaseError: Missing or insufficient permissions`
**해결**: Firebase Console에서 Firestore 보안 규칙 설정

**생성된 파일**: `firestore.rules`
```javascript
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /logs/{logId} {
      allow read, write: if true;
    }
    match /reviews/{reviewId} {
      allow read, write: if true;
    }
    match /earnings/{earningId} {
      allow read, write: if true;
    }
    match /{document=**} {
      allow read, write: if true;
    }
  }
}
```

**적용 방법**:
- Firebase Console → Firestore Database → 규칙(Rules) 탭에서 수동 적용
- 또는 `firebase deploy --only firestore:rules`

---

## 최종 서버 정보

**서버 URL**: http://localhost:3005

**로그인 방법**:
1. http://localhost:3005 접속
2. "관리자 대시보드 보기" 클릭
3. 로그인 페이지에서 "로컬 개발용 세션 발급 (ADMIN_GUARD_BYPASS)" 버튼 클릭
4. 대시보드 자동 이동

**또는 Firebase 계정으로 로그인**:
- Firebase Authentication에 등록된 이메일/비밀번호 사용
- Custom Claim `admin=true` 필요

---

## 수정된 파일 목록

1. `web/.env.local` - Firebase 설정 추가, ADMIN_GUARD_BYPASS 주석 처리
2. `web/lib/firestore.ts` - limit 함수 이름 충돌 수정
3. `web/app/api/admin/session/route.ts` - bypass 로그인 로직 추가
4. `firestore.rules` - Firestore 보안 규칙 생성 (신규)

---

## 해결된 오류 목록

- ✅ Firebase 초기화 실패 (`projectId` 누락)
- ✅ `limit is not a function` 오류
- ✅ Next.js InvariantError (캐시 문제)
- ✅ 바이패스 로그인 `idToken 필요` 오류
- ✅ Firestore 권한 오류 (`Missing or insufficient permissions`)

---

## 참고사항

### measurementId 경고
```
[firebaseClient] Missing Firebase config keys: measurementId
```
- Google Analytics를 위한 선택 사항
- 앱 작동에 영향 없음
- 필요시 Firebase Console → 프로젝트 설정 → 일반 → 내 앱에서 확인 가능

### 보안 주의사항
- 현재 Firestore 규칙은 개발용으로 모든 읽기/쓰기 허용
- 프로덕션 배포 시 더 엄격한 규칙 적용 필요
- `.env.local`은 절대 Git에 커밋하지 말 것

---

## 다음 작업 예정

- [ ] Firebase Admin SDK 설정 (서버 측 작업용)
- [ ] 프로덕션용 Firestore 보안 규칙 작성
- [ ] 실제 데이터 수집 테스트
- [ ] 블로그 포스트 생성 기능 테스트
