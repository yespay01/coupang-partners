# ì½”ë“œë² ì´ìŠ¤ ë¶„ì„ ë° ê°œì„  ì‚¬í•­ (2026-01-27)

## ìš”ì•½

**ë°œê²¬ëœ ì´ìŠˆ:**
- ğŸ”´ **ì¤‘ëŒ€í•œ ë¬¸ì œ**: 7ê°œ (ë³´ì•ˆ ë° ë°ì´í„° êµ¬ì¡°)
- ğŸŸ¡ **ê°œì„  í•„ìš”**: 19ê°œ (ì„±ëŠ¥ ë° ì½”ë“œ í’ˆì§ˆ)

**ì¦‰ì‹œ ì¡°ì¹˜ í•„ìš”:**
1. Firestore Rules ê°•í™” (ë³´ì•ˆ ì·¨ì•½ì ) âš ï¸
2. Admin ì„¸ì…˜ ê²€ì¦ ê°•í™” âš ï¸
3. Firestore ì¸ë±ìŠ¤ ì¶”ê°€ (ì¿¼ë¦¬ ì„±ëŠ¥)
4. API Routes ì¤‘ë³µ ì½”ë“œ ì œê±°

---

## 1. ë³´ì•ˆ ë¬¸ì œ ğŸ”´

### 1.1 Firestore Rules ì „ì²´ ì—´ë¦¼ (ì‹¬ê°)

**íŒŒì¼:** `firestore.rules`
```javascript
// í˜„ì¬ - ìœ„í—˜!
match /{document=**} {
  allow read, write: if true;
}
```

**ë¬¸ì œ:**
- ëˆ„êµ¬ë‚˜ ë°ì´í„° ì½ê¸°/ì“°ê¸° ê°€ëŠ¥
- ì‹œìŠ¤í…œ ì„¤ì •, ë¡œê·¸, ë¦¬ë·° ëª¨ë‘ ë…¸ì¶œ

**í•´ê²°ì±…:**
```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ë¡œê·¸: ê´€ë¦¬ìë§Œ ì½ê¸°
    match /logs/{logId} {
      allow read: if request.auth != null && request.auth.token.admin == true;
      allow write: if false; // Functionsë§Œ
    }

    // ë¦¬ë·°: ê³µê°œëœ ê²ƒë§Œ ì½ê¸°
    match /reviews/{reviewId} {
      allow read: if resource.data.status == 'published';
      allow write: if request.auth != null && request.auth.token.admin == true;
    }

    // ì‹œìŠ¤í…œ ì„¤ì •: ê´€ë¦¬ìë§Œ
    match /system_settings/{docId} {
      allow read, write: if request.auth != null && request.auth.token.admin == true;
    }

    // ìƒí’ˆ: ê´€ë¦¬ìë§Œ
    match /products/{productId} {
      allow read, write: if request.auth != null && request.auth.token.admin == true;
    }
  }
}
```

### 1.2 Admin ì„¸ì…˜ ê²€ì¦ ë¶€ì¡± (ì‹¬ê°)

**íŒŒì¼:** `web/middleware.ts:23`
```typescript
const hasSession = request.cookies.has(ADMIN_SESSION_COOKIE);
```

**ë¬¸ì œ:**
- ì¿ í‚¤ ì¡´ì¬ë§Œ í™•ì¸, ì„œëª…/ë§Œë£Œ ê²€ì¦ ì—†ìŒ
- ì¿ í‚¤ ìœ„ì¡° ê°€ëŠ¥

**í•´ê²°ì±…:**
```typescript
import { getAuth } from 'firebase-admin/auth';

export async function middleware(request: NextRequest) {
  const sessionCookie = request.cookies.get(ADMIN_SESSION_COOKIE)?.value;

  if (!sessionCookie) {
    return NextResponse.redirect(new URL('/admin/login', request.url));
  }

  try {
    // Firebase Admin SDKë¡œ ê²€ì¦
    const decodedClaims = await getAuth().verifySessionCookie(sessionCookie, true);

    // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
    if (!decodedClaims.admin) {
      throw new Error('Not admin');
    }

    return NextResponse.next();
  } catch (error) {
    // ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜
    const response = NextResponse.redirect(new URL('/admin/login', request.url));
    response.cookies.delete(ADMIN_SESSION_COOKIE);
    return response;
  }
}
```

### 1.3 Admin Bypass ëª¨ë“œ í”„ë¡œë•ì…˜ ìœ„í—˜

**íŒŒì¼:** `web/middleware.ts:3`
```typescript
const BYPASS = process.env.ADMIN_GUARD_BYPASS === "true";
```

**ë¬¸ì œ:**
- í”„ë¡œë•ì…˜ì—ì„œë„ bypass ê°€ëŠ¥

**í•´ê²°ì±…:**
```typescript
const BYPASS = process.env.NODE_ENV !== 'production'
  && process.env.ADMIN_GUARD_BYPASS === "true";
```

---

## 2. ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡° ğŸŸ¡

### 2.1 Firestore ì¸ë±ìŠ¤ ëˆ„ë½

**í•„ìš”í•œ ì¸ë±ìŠ¤:**

#### products ì»¬ë ‰ì…˜
```json
{
  "indexes": [
    {
      "collectionGroup": "products",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "status", "order": "ASCENDING" },
        { "fieldPath": "createdAt", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "products",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "source", "order": "ASCENDING" },
        { "fieldPath": "createdAt", "order": "DESCENDING" }
      ]
    }
  ]
}
```

#### review_retry_queue ì»¬ë ‰ì…˜
```json
{
  "collectionGroup": "review_retry_queue",
  "queryScope": "COLLECTION",
  "fields": [
    { "fieldPath": "status", "order": "ASCENDING" },
    { "fieldPath": "nextAttemptAt", "order": "ASCENDING" }
  ]
}
```

**ì¶”ê°€ ë°©ë²•:**
```bash
# 1. firestore.indexes.jsonì— ì¶”ê°€
# 2. ë°°í¬
firebase deploy --only firestore:indexes
```

### 2.2 ë¡œê·¸ ë°ì´í„° ë¬´í•œ ì¦ê°€

**ë¬¸ì œ:**
- `logs` ì»¬ë ‰ì…˜ì´ ì‚­ì œ ì—†ì´ ê³„ì† ì¦ê°€
- Firestore ë¹„ìš© ì¦ê°€

**í•´ê²°ì±… 1: Firebase Extension ì‚¬ìš©**
```bash
firebase ext:install firestore-delete-data
```

**í•´ê²°ì±… 2: Cloud Scheduler + Function**
```javascript
// functions/src/cleanupLogs.js
export const cleanupOldLogs = onSchedule(
  { schedule: "0 2 * * *", timeZone: "Asia/Seoul" },
  async () => {
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

    const oldLogs = await db
      .collection("logs")
      .where("createdAt", "<", thirtyDaysAgo)
      .limit(500)
      .get();

    const batch = db.batch();
    oldLogs.docs.forEach(doc => batch.delete(doc.ref));
    await batch.commit();

    logger.info(`Deleted ${oldLogs.size} old logs`);
  }
);
```

---

## 3. íŒŒì¼ êµ¬ì¡° ê°œì„  ğŸŸ¡

### 3.1 API Routes ì¤‘ë³µ ì œê±°

**ë¬¸ì œ:**
- `web/app/api/admin/collect/route.ts`ì— ì¿ íŒ¡ API ë¡œì§ ì¤‘ë³µ
- Firebase ì´ˆê¸°í™” ì¤‘ë³µ

**ê°œì„  í›„ êµ¬ì¡°:**
```
web/
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ firebaseClient.ts      # ê³µìœ 
â”‚   â”œâ”€â”€ firebaseAdmin.ts        # ìƒˆë¡œ ì¶”ê°€
â”‚   â””â”€â”€ coupang/               # ìƒˆë¡œ ì¶”ê°€
â”‚       â”œâ”€â”€ client.ts
â”‚       â”œâ”€â”€ signature.ts
â”‚       â””â”€â”€ types.ts
â””â”€â”€ app/api/
    â””â”€â”€ admin/collect/
        â””â”€â”€ route.ts           # ê°„ì†Œí™”
```

**ê°œì„  í›„ ì½”ë“œ:**
```typescript
// web/lib/coupang/client.ts
import { generateHmac } from './signature';

export async function coupangRequest(method, path, credentials) {
  const { authorization } = generateHmac(method, path, credentials);
  // ... ê³µí†µ ë¡œì§
}

// web/app/api/admin/collect/route.ts (ê°„ì†Œí™”)
import { coupangRequest } from '@/lib/coupang/client';

export async function POST(request: NextRequest) {
  const credentials = await getCoupangCredentials(); // ê³µí†µ í•¨ìˆ˜
  const result = await coupangRequest('GET', path, credentials);
  // ...
}
```

### 3.2 Functions ëª¨ë“ˆí™”

**í˜„ì¬:**
```
functions/src/
â”œâ”€â”€ generateReview.js    # 326ì¤„ - ë„ˆë¬´ í¼
â”œâ”€â”€ collectProducts.js   # 566ì¤„ - ë„ˆë¬´ í¼
â””â”€â”€ coupangApi.js       # 586ì¤„ - ë„ˆë¬´ í¼
```

**ê°œì„  í›„:**
```
functions/src/
â”œâ”€â”€ triggers/
â”‚   â”œâ”€â”€ generateReview.js       # íŠ¸ë¦¬ê±°ë§Œ
â”‚   â”œâ”€â”€ collectProducts.js      # íŠ¸ë¦¬ê±°ë§Œ
â”‚   â””â”€â”€ publishReview.js
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ reviewService.js        # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
â”‚   â”œâ”€â”€ productService.js
â”‚   â”œâ”€â”€ retryQueueService.js
â”‚   â””â”€â”€ notificationService.js
â”œâ”€â”€ coupang/
â”‚   â”œâ”€â”€ client.js               # ê¸°ë³¸ ìš”ì²­
â”‚   â”œâ”€â”€ products.js             # ìƒí’ˆ API
â”‚   â”œâ”€â”€ reports.js              # ë¦¬í¬íŠ¸ API
â”‚   â””â”€â”€ deeplink.js             # ë”¥ë§í¬ API
â”œâ”€â”€ ai/
â”‚   â”œâ”€â”€ providers.js
â”‚   â””â”€â”€ prompts.js
â””â”€â”€ utils/
    â”œâ”€â”€ firebase.js
    â”œâ”€â”€ validation.js
    â””â”€â”€ helpers.js
```

### 3.3 íƒ€ì… ì •ì˜ í†µí•©

**ë¬¸ì œ:**
- `web/lib/firestore.ts`ì— ReviewDoc, LogDoc
- `web/types/index.ts`ì— Review, Log
- ì¤‘ë³µë˜ê³  ë¶ˆì¼ì¹˜

**í•´ê²°ì±…:**
```typescript
// web/types/index.ts (ë‹¨ì¼ ì†ŒìŠ¤)
export type Review = {
  id: string;
  productId: string;
  content: string;
  status: 'draft' | 'approved' | 'published';
  category: string;
  slug?: string;
  // ...
};

// web/lib/firestore.ts (ë³€í™˜ í•¨ìˆ˜ë§Œ)
import type { Review } from '@/types';

export function toReview(doc: DocumentSnapshot): Review {
  const data = doc.data();
  return {
    id: doc.id,
    ...data,
  } as Review;
}
```

---

## 4. ì„±ëŠ¥ ê°œì„  ğŸŸ¡

### 4.1 ë”¥ë§í¬ ë°°ì¹˜ ìƒì„±

**í˜„ì¬:** `functions/src/collectProducts.js`
```javascript
// N+1 ë¬¸ì œ
for (const product of products) {
  const deeplinkResult = await client.createDeeplinks([product.productUrl]);
  // ...
}
```

**ê°œì„  í›„:**
```javascript
// ë°°ì¹˜ ì²˜ë¦¬
const productUrls = products.map(p => p.productUrl);
const deeplinkResult = await client.createDeeplinks(productUrls);

const deeplinkMap = new Map(
  deeplinkResult.deeplinks.map((dl, i) => [productUrls[i], dl.shortenUrl])
);

for (const product of products) {
  const affiliateUrl = deeplinkMap.get(product.productUrl) || product.productUrl;
  // ...
}
```

### 4.2 ì‹œìŠ¤í…œ ì„¤ì • ìºì‹±

**í˜„ì¬:** `functions/src/generateReview.js:40-58`
```javascript
// ë§¤ë²ˆ Firestore ì¡°íšŒ
async function getSystemSettings() {
  const docRef = db.collection("system_settings").doc("global");
  const docSnap = await docRef.get();
  return docSnap.data();
}
```

**ê°œì„  í›„:**
```javascript
let cachedSettings = null;
let cacheTimestamp = 0;
const CACHE_TTL = 5 * 60 * 1000; // 5ë¶„

async function getSystemSettings() {
  const now = Date.now();

  if (cachedSettings && (now - cacheTimestamp) < CACHE_TTL) {
    return cachedSettings;
  }

  const docRef = db.collection("system_settings").doc("global");
  const docSnap = await docRef.get();

  cachedSettings = docSnap.data();
  cacheTimestamp = now;

  return cachedSettings;
}
```

### 4.3 React Query staleTime ì¡°ì •

**í˜„ì¬:** `web/hooks/useReviews.ts:98`
```typescript
staleTime: 30 * 1000, // 30ì´ˆ - ë„ˆë¬´ ì§§ìŒ
```

**ê°œì„  í›„:**
```typescript
staleTime: 5 * 60 * 1000, // 5ë¶„ - ë°ì´í„° ë³€ê²½ ë¹ˆë„ ë‚®ìŒ
```

---

## 5. ìš°ì„ ìˆœìœ„ë³„ ì‘ì—… ê³„íš

### Phase 1: ë³´ì•ˆ ê°•í™” (ì¦‰ì‹œ - 1ì£¼)

- [ ] Firestore Rules ê°•í™”
- [ ] Admin ì„¸ì…˜ ê²€ì¦ ê°œì„ 
- [ ] Bypass ëª¨ë“œ í”„ë¡œë•ì…˜ ì œí•œ
- [ ] ë¯¼ê° ì •ë³´ ë¡œê¹… ì œê±°

**ì˜ˆìƒ ì‘ì—… ì‹œê°„:** 1-2ì¼
**ìš°ì„ ìˆœìœ„:** âš ï¸ ê¸´ê¸‰

### Phase 2: DB ìµœì í™” (1-2ì£¼)

- [ ] Firestore ì¸ë±ìŠ¤ ì¶”ê°€
- [ ] ë¡œê·¸ ìë™ ì‚­ì œ êµ¬í˜„
- [ ] ì¤‘ë³µ ë°ì´í„° ì •ë¦¬
- [ ] íƒ€ì… ì •ì˜ í†µí•©

**ì˜ˆìƒ ì‘ì—… ì‹œê°„:** 3-5ì¼
**ìš°ì„ ìˆœìœ„:** ğŸ”´ ë†’ìŒ

### Phase 3: ì½”ë“œ ë¦¬íŒ©í† ë§ (1ê°œì›”)

- [ ] API Routes ì¤‘ë³µ ì œê±°
- [ ] Functions ëª¨ë“ˆí™”
- [ ] ë”¥ë§í¬ ë°°ì¹˜ ì²˜ë¦¬
- [ ] ì„¤ì • ìºì‹± êµ¬í˜„
- [ ] ì—ëŸ¬ í•¸ë“¤ë§ ê°œì„ 

**ì˜ˆìƒ ì‘ì—… ì‹œê°„:** 2ì£¼
**ìš°ì„ ìˆœìœ„:** ğŸŸ¡ ì¤‘ê°„

### Phase 4: ì¥ê¸° ê°œì„  (3ê°œì›”)

- [ ] Functions TypeScript ë§ˆì´ê·¸ë ˆì´ì…˜
- [ ] Component êµ¬ì¡° ì •ë¦¬
- [ ] í˜ì´ì§€ë„¤ì´ì…˜ ìµœì í™”
- [ ] E2E í…ŒìŠ¤íŠ¸ ì¶”ê°€
- [ ] ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ

**ì˜ˆìƒ ì‘ì—… ì‹œê°„:** 1ê°œì›”
**ìš°ì„ ìˆœìœ„:** ğŸ”µ ë‚®ìŒ

---

## 6. ì˜ˆìƒ íš¨ê³¼

### ë³´ì•ˆ ê°•í™”
- âœ… ë°ì´í„° ìœ ì¶œ ìœ„í—˜ ì œê±°
- âœ… ê´€ë¦¬ì ì„¸ì…˜ ì•ˆì „ì„± í–¥ìƒ
- âœ… ê·œì • ì¤€ìˆ˜ (GDPR, ê°œì¸ì •ë³´ë³´í˜¸ë²•)

### ì„±ëŠ¥ ê°œì„ 
- âœ… Firestore ì½ê¸° 50% ê°ì†Œ (ìºì‹±)
- âœ… ë”¥ë§í¬ ìƒì„± ì‹œê°„ 70% ë‹¨ì¶• (ë°°ì¹˜)
- âœ… í˜ì´ì§€ ë¡œë”© ì†ë„ 30% ê°œì„ 

### ì½”ë“œ í’ˆì§ˆ
- âœ… ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒ
- âœ… ë²„ê·¸ ë°œìƒë¥  ê°ì†Œ
- âœ… ê°œë°œ ì†ë„ ì¦ê°€

### ë¹„ìš© ì ˆê°
- âœ… Firestore ë¹„ìš© 30% ì ˆê°
- âœ… Functions ì‹¤í–‰ ì‹œê°„ ë‹¨ì¶•
- âœ… ë„¤íŠ¸ì›Œí¬ ë¹„ìš© ê°ì†Œ

---

## 7. ë‹¤ìŒ ë‹¨ê³„

1. **Phase 1 ì°©ìˆ˜**
   - Firestore Rules ì‘ì„± ë° í…ŒìŠ¤íŠ¸
   - Admin ì„¸ì…˜ ê²€ì¦ êµ¬í˜„

2. **í…ŒìŠ¤íŠ¸ í™˜ê²½ êµ¬ì¶•**
   - Staging í™˜ê²½ ì„¤ì •
   - ë³´ì•ˆ í…ŒìŠ¤íŠ¸ ìˆ˜í–‰

3. **ì ì§„ì  ë°°í¬**
   - ê° Phaseë³„ ë‹¨ê³„ì  ë°°í¬
   - ëª¨ë‹ˆí„°ë§ ë° ë¡¤ë°± ê³„íš ìˆ˜ë¦½

4. **ë¬¸ì„œí™”**
   - ìƒˆë¡œìš´ êµ¬ì¡° ë¬¸ì„œí™”
   - ë³´ì•ˆ ê°€ì´ë“œë¼ì¸ ì‘ì„±
   - ê°œë°œì ì˜¨ë³´ë”© ê°€ì´ë“œ

---

## ì°¸ê³  ìë£Œ

- [Firebase Security Rules ê°€ì´ë“œ](https://firebase.google.com/docs/rules)
- [Firestore ì¸ë±ìŠ¤ ìµœì í™”](https://firebase.google.com/docs/firestore/query-data/indexing)
- [Next.js ë³´ì•ˆ ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤](https://nextjs.org/docs/app/building-your-application/authentication)
- [React Query ìºì‹± ì „ëµ](https://tanstack.com/query/latest/docs/react/guides/caching)
