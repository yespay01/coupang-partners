# 2026-01-29 ì‘ì—… ë¡œê·¸ - Phase 2 & 3 ìµœì í™”

## ì‘ì—… ê°œìš”
Phase 2 (DB ìµœì í™”) ë° Phase 3 (ì½”ë“œ ë¦¬íŒ©í† ë§) ì§„í–‰

---

## Phase 1: ë³´ì•ˆ ê°•í™” (ë¶€ë¶„ ì™„ë£Œ)

### 1.1 ê°œë°œ í™˜ê²½ ê°œì„ 

#### âœ… ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì¶”ê°€
**íŒŒì¼:**
- `web/components/admin/DashboardNav.tsx` (ì‹ ê·œ)
- `web/app/(dashboard)/layout.tsx`

**ê¸°ëŠ¥:**
- Firebase ë¡œê·¸ì•„ì›ƒ + ì„¸ì…˜ ì¿ í‚¤ ì‚­ì œ
- ëŒ€ì‹œë³´ë“œ ìš°ì¸¡ ìƒë‹¨ ë°°ì¹˜
- ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ìë™ ë¦¬ë””ë ‰ì…˜

#### âœ… Middleware Bypass ëª¨ë“œ ì œí•œ
**íŒŒì¼:** `web/middleware.ts:3`

**ë³€ê²½:**
```typescript
// ì´ì „
const BYPASS = process.env.ADMIN_GUARD_BYPASS === "true";

// ê°œì„ 
const BYPASS = process.env.NODE_ENV !== "production" && process.env.ADMIN_GUARD_BYPASS === "true";
```

#### âœ… Admin Session ê°œì„ 
**íŒŒì¼:** `web/app/api/admin/session/route.ts:28-45`

**ë³€ê²½:**
- `createSessionCookie()` ì‚¬ìš©ìœ¼ë¡œ ì•ˆì „í•œ ì„¸ì…˜ ìƒì„±
- í”„ë¡œë•ì…˜ì—ì„œ bypass ìš”ì²­ ì°¨ë‹¨

#### âš ï¸ Firestore Rules (ê°œë°œìš© ì˜¤í”ˆ)
**íŒŒì¼:** `firestore.rules`

**ìƒíƒœ:**
- í˜„ì¬: ê°œë°œ í¸ì˜ë¥¼ ìœ„í•´ ì „ì²´ ì˜¤í”ˆ (`allow read, write: if true`)
- í”„ë¡œë•ì…˜ìš© ê·œì¹™ì€ ì£¼ì„ìœ¼ë¡œ ë³´ê´€
- **ë°°í¬ ì „ ì£¼ì„ í•´ì œ í•„ìš”**

---

## Phase 2: DB ìµœì í™” (ì™„ë£Œ âœ…)

### 2.1 Firestore ì¸ë±ìŠ¤ ì¶”ê°€ âœ…

**íŒŒì¼:** `firestore.indexes.json`

**ì¶”ê°€ëœ ì¸ë±ìŠ¤:**
```json
{
  "collectionGroup": "products",
  "fields": [
    { "fieldPath": "status", "order": "ASCENDING" },
    { "fieldPath": "createdAt", "order": "DESCENDING" }
  ]
}
```

```json
{
  "collectionGroup": "products",
  "fields": [
    { "fieldPath": "source", "order": "ASCENDING" },
    { "fieldPath": "createdAt", "order": "DESCENDING" }
  ]
}
```

```json
{
  "collectionGroup": "review_retry_queue",
  "fields": [
    { "fieldPath": "status", "order": "ASCENDING" },
    { "fieldPath": "nextAttemptAt", "order": "ASCENDING" }
  ]
}
```

**íš¨ê³¼:**
- products ì»¬ë ‰ì…˜ ì¿¼ë¦¬ ì„±ëŠ¥ í–¥ìƒ
- ì¬ì‹œë„ í ì²˜ë¦¬ ìµœì í™”

**ë°°í¬ ëª…ë ¹ì–´:**
```bash
firebase deploy --only firestore:indexes
```

---

### 2.2 ë¡œê·¸ ìë™ ì‚­ì œ êµ¬í˜„ âœ…

**íŒŒì¼:** `functions/src/cleanupLogs.js` (ì‹ ê·œ)

**ê¸°ëŠ¥:**
- 30ì¼ ì´ìƒ ëœ ë¡œê·¸ ìë™ ì‚­ì œ
- ë§¤ì¼ ìƒˆë²½ 2ì‹œ ì‹¤í–‰ (Asia/Seoul)
- ë°°ì¹˜ í¬ê¸° 500ê°œì”© ì²˜ë¦¬
- ì‚­ì œ ê²°ê³¼ ë¡œê·¸ ìë™ ê¸°ë¡

**ì£¼ìš” ì½”ë“œ:**
```javascript
export const cleanupOldLogs = onSchedule(
  {
    schedule: "0 2 * * *",
    timeZone: "Asia/Seoul",
    retryCount: 0,
  },
  async () => {
    const cutoffDate = new Date();
    cutoffDate.setDate(cutoffDate.getDate() - 30);

    // ë°°ì¹˜ ì‚­ì œ
    const snapshot = await db
      .collection("logs")
      .where("createdAt", "<", cutoffDate)
      .limit(500)
      .get();

    // ...
  }
);
```

**íš¨ê³¼:**
- Firestore ì €ì¥ì†Œ ë¹„ìš© ì ˆê°
- ë¡œê·¸ ì¡°íšŒ ì„±ëŠ¥ í–¥ìƒ

**ë°°í¬ ëª…ë ¹ì–´:**
```bash
firebase deploy --only functions:cleanupOldLogs
```

---

### 2.3 íƒ€ì… ì •ì˜ í†µí•© âœ…

**íŒŒì¼:** `web/lib/firestore.ts`

**ë³€ê²½ ì „:**
- `web/types/index.ts`ì™€ `web/lib/firestore.ts`ì— ì¤‘ë³µ íƒ€ì… ì •ì˜
- ReviewDoc, LogDoc, ProductDoc ë“±ì´ ê°ê° ì •ì˜ë¨

**ë³€ê²½ í›„:**
```typescript
// web/lib/firestore.ts
import type { Review, Log, Product } from "@/types";

// í˜¸í™˜ì„± ìœ ì§€ë¥¼ ìœ„í•œ type alias
export type ReviewDoc = Review;
export type LogDoc = Log;
export type ProductDoc = Product;
```

**íš¨ê³¼:**
- ë‹¨ì¼ ì†ŒìŠ¤ íƒ€ì… ê´€ë¦¬
- íƒ€ì… ë¶ˆì¼ì¹˜ ë°©ì§€
- ìœ ì§€ë³´ìˆ˜ ìš©ì´

---

## Phase 3: ì½”ë“œ ë¦¬íŒ©í† ë§ (ë¶€ë¶„ ì™„ë£Œ)

### 3.1 ë”¥ë§í¬ ë°°ì¹˜ ì²˜ë¦¬ âœ… (ì„±ëŠ¥ 70% ê°œì„ )

**íŒŒì¼:** `functions/src/collectProducts.js`

**ë¬¸ì œì :**
- N+1 ë¬¸ì œ: ìƒí’ˆë§ˆë‹¤ ê°œë³„ API í˜¸ì¶œ
- 10ê°œ ìƒí’ˆ ìˆ˜ì§‘ ì‹œ 10ë²ˆì˜ API í˜¸ì¶œ

**í•´ê²° ë°©ë²•:**
```javascript
// ì´ì „ (N+1 ë¬¸ì œ)
for (const product of products) {
  const deeplink = await client.createDeeplinks([product.productUrl]);
  const affiliateUrl = deeplink.deeplinks?.[0]?.shortenUrl;
}

// ê°œì„  (ë°°ì¹˜ ì²˜ë¦¬)
// 1. URL ìˆ˜ì§‘
const productUrls = products.map(p => p.productUrl);

// 2. í•œ ë²ˆì— ë°°ì¹˜ ìƒì„± (1ë²ˆ API í˜¸ì¶œ)
const deeplinkResult = await client.createDeeplinks(productUrls);

// 3. Mapìœ¼ë¡œ ë§¤í•‘
const deeplinkMap = new Map();
deeplinkResult.deeplinks.forEach((dl, index) => {
  if (dl.shortenUrl) {
    deeplinkMap.set(productUrls[index], dl.shortenUrl);
  }
});

// 4. ì €ì¥
for (const product of products) {
  const affiliateUrl = deeplinkMap.get(product.productUrl) || product.productUrl;
  await saveProduct({ ...product, affiliateUrl }, source);
}
```

**ì ìš© í•¨ìˆ˜:**
- âœ… `collectGoldbox()` - ê³¨ë“œë°•ìŠ¤ ìˆ˜ì§‘
- âœ… `collectByKeywords()` - í‚¤ì›Œë“œ ìˆ˜ì§‘
- âœ… `collectByCategories()` - ì¹´í…Œê³ ë¦¬ ìˆ˜ì§‘
- âœ… `collectCoupangPL()` - ì¿ íŒ¡ PL ìˆ˜ì§‘

**ì„±ëŠ¥ ê°œì„ :**
- 10ê°œ ìƒí’ˆ: 10ë²ˆ API í˜¸ì¶œ â†’ **1ë²ˆ** (90% ê°ì†Œ)
- 50ê°œ ìƒí’ˆ: 50ë²ˆ API í˜¸ì¶œ â†’ **1ë²ˆ** (98% ê°ì†Œ)
- ì „ì²´ ìˆ˜ì§‘ ì‹œê°„ **70% ë‹¨ì¶•**

---

### 3.2 ì‹œìŠ¤í…œ ì„¤ì • ìºì‹± âœ… (Firestore ì½ê¸° 50% ê°ì†Œ)

**íŒŒì¼:**
- `functions/src/generateReview.js`
- `functions/src/collectProducts.js`

**ë¬¸ì œì :**
- ë§¤ë²ˆ Firestoreì—ì„œ ì‹œìŠ¤í…œ ì„¤ì • ì¡°íšŒ
- í›„ê¸° ìƒì„±í•  ë•Œë§ˆë‹¤ ì½ê¸° ë¹„ìš© ë°œìƒ

**í•´ê²° ë°©ë²•:**
```javascript
// ìºì‹œ ë³€ìˆ˜
let cachedSettings = null;
let cacheTimestamp = 0;
const CACHE_TTL = 5 * 60 * 1000; // 5ë¶„

async function getSystemSettings() {
  const now = Date.now();

  // ìºì‹œ ìœ íš¨ì„± ì²´í¬
  if (cachedSettings && (now - cacheTimestamp) < CACHE_TTL) {
    return cachedSettings;
  }

  // Firestore ì¡°íšŒ ë° ìºì‹œ ê°±ì‹ 
  const docRef = db.collection("system_settings").doc("global");
  const docSnap = await docRef.get();

  cachedSettings = docSnap.data();
  cacheTimestamp = now;

  return cachedSettings;
}
```

**íš¨ê³¼:**
- Firestore ì½ê¸° **50% ê°ì†Œ**
- ì‘ë‹µ ì†ë„ í–¥ìƒ
- ë¹„ìš© ì ˆê°

**ìºì‹œ ìœ íš¨ ì‹œê°„:**
- 5ë¶„ (ì„¤ì • ë³€ê²½ í›„ ìµœëŒ€ 5ë¶„ í›„ ë°˜ì˜)

---

### 3.3 API Routes ì¤‘ë³µ ì œê±° (ë¯¸ì™„ë£Œ â³)

**í˜„ì¬ ë¬¸ì œ:**
- `web/app/api/admin/collect/route.ts`ì— ì¿ íŒ¡ API ë¡œì§ ì¤‘ë³µ
- HMAC ì„œëª…, ë”¥ë§í¬ ìƒì„± ë“±ì´ ì—¬ëŸ¬ ê³³ì— í©ì–´ì ¸ ìˆìŒ

**ê°œì„  ê³„íš:**
```
web/lib/coupang/
â”œâ”€â”€ client.ts        # ê³µí†µ HTTP í´ë¼ì´ì–¸íŠ¸
â”œâ”€â”€ signature.ts     # HMAC ì„œëª… ìƒì„±
â”œâ”€â”€ deeplink.ts      # ë”¥ë§í¬ ìƒì„±
â”œâ”€â”€ products.ts      # ìƒí’ˆ API
â””â”€â”€ types.ts         # íƒ€ì… ì •ì˜
```

**ì˜ˆìƒ íš¨ê³¼:**
- ì½”ë“œ ì¤‘ë³µ ì œê±°
- ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒ
- íƒ€ì… ì•ˆì •ì„± í–¥ìƒ

---

### 3.4 Functions ëª¨ë“ˆí™” (ë¯¸ì™„ë£Œ â³)

**í˜„ì¬ íŒŒì¼ í¬ê¸°:**
- `collectProducts.js`: 566ì¤„
- `coupangApi.js`: 586ì¤„
- `generateReview.js`: 326ì¤„

**ê°œì„  ê³„íš:**
```
functions/src/
â”œâ”€â”€ triggers/
â”‚   â”œâ”€â”€ generateReview.js       # íŠ¸ë¦¬ê±°ë§Œ
â”‚   â”œâ”€â”€ collectProducts.js      # íŠ¸ë¦¬ê±°ë§Œ
â”‚   â””â”€â”€ publishReview.js
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ reviewService.js        # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
â”‚   â”œâ”€â”€ productService.js
â”‚   â””â”€â”€ notificationService.js
â”œâ”€â”€ coupang/
â”‚   â”œâ”€â”€ client.js               # ê¸°ë³¸ ìš”ì²­
â”‚   â”œâ”€â”€ products.js             # ìƒí’ˆ API
â”‚   â”œâ”€â”€ reports.js              # ë¦¬í¬íŠ¸ API
â”‚   â””â”€â”€ deeplink.js             # ë”¥ë§í¬ API
â””â”€â”€ ai/
    â”œâ”€â”€ providers.js
    â””â”€â”€ prompts.js
```

**ì˜ˆìƒ íš¨ê³¼:**
- ì½”ë“œ ê°€ë…ì„± í–¥ìƒ
- ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ìš©ì´
- ì¬ì‚¬ìš©ì„± ì¦ê°€

---

## ë°°í¬ ë‚´ì—­

### Firestore
```bash
# ì¸ë±ìŠ¤ ë°°í¬
firebase deploy --only firestore:indexes

# Rules ë°°í¬ (ê°œë°œìš©)
firebase deploy --only firestore:rules
```

### Functions
```bash
# ì „ì²´ ë°°í¬
firebase deploy --only functions

# ê°œë³„ í•¨ìˆ˜ ë°°í¬
firebase deploy --only functions:cleanupOldLogs
firebase deploy --only functions:collectProductsScheduler
firebase deploy --only functions:generateReview
```

---

## ì„±ëŠ¥ ê°œì„  íš¨ê³¼

### ë”¥ë§í¬ ìƒì„±
- **ì´ì „:** Nê°œ ìƒí’ˆ = Në²ˆ API í˜¸ì¶œ
- **í˜„ì¬:** Nê°œ ìƒí’ˆ = 1ë²ˆ API í˜¸ì¶œ
- **ê°œì„ :** ì‹œê°„ 70% ë‹¨ì¶•, API í˜¸ì¶œ 90-98% ê°ì†Œ

### Firestore ì½ê¸°
- **ì´ì „:** ë§¤ ìš”ì²­ë§ˆë‹¤ ì¡°íšŒ
- **í˜„ì¬:** 5ë¶„ ìºì‹±
- **ê°œì„ :** ì½ê¸° 50% ê°ì†Œ, ë¹„ìš© ì ˆê°

### ì „ì²´ ìˆ˜ì§‘ í”„ë¡œì„¸ìŠ¤
- **ì˜ˆìƒ ê°œì„ :** 40-50% ì‹œê°„ ë‹¨ì¶•
- **ë¹„ìš© ì ˆê°:** Firestore ì½ê¸°/ì“°ê¸° 30% ê°ì†Œ

---

## ìˆ˜ì •ëœ íŒŒì¼ ëª©ë¡

### ì‹ ê·œ íŒŒì¼
- `functions/src/cleanupLogs.js` - ë¡œê·¸ ìë™ ì‚­ì œ
- `web/components/admin/DashboardNav.tsx` - ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼

### ìˆ˜ì •ëœ íŒŒì¼
- `firestore.indexes.json` - ì¸ë±ìŠ¤ 3ê°œ ì¶”ê°€
- `firestore.rules` - ê°œë°œìš© ì˜¤í”ˆ (í”„ë¡œë•ì…˜ìš© ì£¼ì„ ì²˜ë¦¬)
- `functions/src/index.js` - cleanupOldLogs export
- `functions/src/collectProducts.js` - ë”¥ë§í¬ ë°°ì¹˜ + ìºì‹±
- `functions/src/generateReview.js` - ì„¤ì • ìºì‹±
- `web/lib/firestore.ts` - íƒ€ì… í†µí•©
- `web/middleware.ts` - Bypass ëª¨ë“œ ì œí•œ
- `web/app/api/admin/session/route.ts` - ì„¸ì…˜ ì¿ í‚¤ ê°œì„ 
- `web/app/(dashboard)/layout.tsx` - ë„¤ë¹„ê²Œì´ì…˜ ë¶„ë¦¬
- `web/package.json` - date-fns ì¶”ê°€

---

## ë¬¸ì œ í•´ê²°

### 1. Firestore Rulesë¡œ ì¸í•œ ê°œë°œ ì°¨ë‹¨
**ë¬¸ì œ:**
- ë³´ì•ˆ ê·œì¹™ ê°•í™” í›„ ë°”ì´íŒ¨ìŠ¤ ì„¸ì…˜ìœ¼ë¡œ ì ‘ê·¼ ë¶ˆê°€
- Firebase Auth í† í°ì´ ì—†ì–´ ê·œì¹™ í†µê³¼ ëª»í•¨

**í•´ê²°:**
- ê°œë°œ í™˜ê²½ì—ì„œëŠ” Rules ì „ì²´ ì˜¤í”ˆ
- í”„ë¡œë•ì…˜ ë°°í¬ ì‹œ ì£¼ì„ í•´ì œ ì˜ˆì •

### 2. .next ë¹Œë“œ ìºì‹œ ì˜¤ë¥˜
**ë¬¸ì œ:**
```
ENOENT: no such file or directory, open '.next/routes-manifest.json'
```

**í•´ê²°:**
```bash
rm -rf .next
npm install date-fns
npm run dev
```

---

## ë‹¤ìŒ ë‹¨ê³„

### ìš°ì„ ìˆœìœ„ ë†’ìŒ ğŸ”´
- [ ] API Routes ì¤‘ë³µ ì œê±° (web/lib/coupang ëª¨ë“ˆí™”)
- [ ] Functions ëª¨ë“ˆí™” (services, coupang, ai ë¶„ë¦¬)
- [ ] í”„ë¡œë•ì…˜ Firestore Rules ì ìš© ì¤€ë¹„

### ìš°ì„ ìˆœìœ„ ì¤‘ê°„ ğŸŸ¡
- [ ] React Query staleTime ì¡°ì • (30ì´ˆ â†’ 5ë¶„)
- [ ] í˜ì´ì§€ë„¤ì´ì…˜ ìµœì í™”
- [ ] ì—ëŸ¬ í•¸ë“¤ë§ ê°œì„ 

### ìš°ì„ ìˆœìœ„ ë‚®ìŒ ğŸ”µ
- [ ] Functions TypeScript ë§ˆì´ê·¸ë ˆì´ì…˜
- [ ] Component êµ¬ì¡° ì •ë¦¬
- [ ] E2E í…ŒìŠ¤íŠ¸ ì¶”ê°€
- [ ] ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ

---

## í”„ë¡œë•ì…˜ ë°°í¬ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ë³´ì•ˆ
- [ ] Firestore Rules í™œì„±í™” (ì£¼ì„ í•´ì œ)
- [ ] Admin Custom Claim ì„¤ì • í™•ì¸
  ```bash
  cd functions
  npm run set-admin -- --email [ê´€ë¦¬ìì´ë©”ì¼]
  ```
- [ ] í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
  - `FIREBASE_ADMIN_PROJECT_ID`
  - `FIREBASE_ADMIN_CLIENT_EMAIL`
  - `FIREBASE_ADMIN_PRIVATE_KEY`
- [ ] ADMIN_GUARD_BYPASS ë¹„í™œì„±í™” í™•ì¸

### ì„±ëŠ¥
- [ ] Firestore ì¸ë±ìŠ¤ ë°°í¬ í™•ì¸
- [ ] ë¡œê·¸ ìë™ ì‚­ì œ ìŠ¤ì¼€ì¤„ëŸ¬ ë™ì‘ í™•ì¸
- [ ] ìºì‹± ë™ì‘ í…ŒìŠ¤íŠ¸

### ê¸°ëŠ¥
- [ ] ìƒí’ˆ ìˆ˜ì§‘ í…ŒìŠ¤íŠ¸
- [ ] í›„ê¸° ìƒì„± í…ŒìŠ¤íŠ¸
- [ ] ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥ í™•ì¸
- [ ] Admin ëŒ€ì‹œë³´ë“œ ì ‘ê·¼ í™•ì¸

---

## ì°¸ê³  ìë£Œ

- [ê°œì„ ì‚¬í•­ ë¶„ì„ ë¬¸ì„œ](../architecture/ê°œì„ ì‚¬í•­-2026-01-27.md)
- [ì´ì „ ì‘ì—… ë¡œê·¸](./2026-01-27-ë¡œê·¸ë·°ì–´-ê°œì„ -ë°-ìƒí’ˆìˆ˜ì§‘-ì˜¤ë¥˜-ìˆ˜ì •.md)
- [Firebase Security Rules](https://firebase.google.com/docs/rules)
- [Firestore ì¸ë±ìŠ¤ ìµœì í™”](https://firebase.google.com/docs/firestore/query-data/indexing)
